### CSV 분석 챗봇 시스템 아키텍처 및 데이터 흐름

#### 1. 개요

이 시스템은 사용자가 웹 UI를 통해 CSV 파일을 업로드하고, 해당 파일의 데이터에 대해 자연어로 질문하면 AI가 분석하여 답변해주는 챗봇입니다. 시스템은 **Django 프론트엔드**와 **FastAPI 백엔드**라는 두 개의 주요 부분으로 구성되어 있습니다.

-   **프론트엔드 (Django):** 사용자 인터페이스(UI)를 제공하고, 파일 업로드 및 채팅 메시지 전송과 같은 사용자 상호작용을 처리합니다.
-   **백엔드 (FastAPI):** 실제 AI 분석 로직을 수행합니다. LangChain과 OpenAI API를 사용하여 사용자의 질문을 이해하고, CSV 데이터를 분석하여 답변을 생성합니다.

---

#### 2. 핵심 파일 및 역할
v
| 파일 경로                                                     | 역할                                                                                                 | 설명                                                                                                                                                                                                                                                                                       |
| :------------------------------------------------------------ | :--------------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `backend/templates/conversations/chatbot.html`                | **사용자 인터페이스 (UI)**                                                                           | 사용자가 파일을 업로드하고, 메시지를 입력하며, 챗봇의 답변을 보는 화면입니다. 모든 프론트엔드 로직은 이 파일의 JavaScript 코드에 포함되어 있습니다.                                                                                                                                                |
| `backend/conversations/views.py`                              | **파일 업로드 처리**                                                                                 | `chatbot.html`에서 업로드된 CSV 파일을 받아 AWS S3 버킷에 저장합니다. 저장 후, 파일에 접근할 수 있는 고유 키(`s3_object_key`)를 생성하여 다시 프론트엔드로 전달합니다.                                                                                                                            |
| `download_script.py`                                          | **S3 파일 다운로드**                                                                                 | FastAPI 서버가 S3에 저장된 CSV 파일을 분석하기 위해, 해당 파일을 서버의 임시 공간으로 다운로드하는 역할을 수행하는 독립적인 스크립트입니다.                                                                                                                                                     |
| `fastapi_server/agent/tools.py`                               | **데이터 분석 도구**                                                                                 | **"Code Interpreter"** 로직이 구현된 핵심 파일입니다. S3에서 다운로드한 CSV 파일을 `pandas`로 읽고, AI를 이용해 분석 코드를 생성 및 실행하여 최종 답변을 만듭니다.                                                                                                                              |
| `fastapi_server/main.py`                                      | **API 엔드포인트**                                                                                   | 프론트엔드로부터 채팅 메시지와 `s3_object_key`를 받아, `tools.py`에 정의된 분석 함수(`analyze_csv_data`)를 호출하고, 생성된 답변을 다시 프론트엔드로 스트리밍하여 전송하는 API 서버입니다.                                                                                                        |

---

#### 3. 데이터 흐름 (단계별 설명)

**1단계: 파일 업로드**

1.  **사용자:** `chatbot.html` 페이지에서 "CSV 업로드" 버튼을 클릭하여 로컬 파일을 선택합니다.
2.  **프론트엔드 (`chatbot.html`):** 선택된 파일을 JavaScript의 `fetch` API를 통해 Django 서버의 `/conversations/upload_csv/` URL로 전송합니다.
3.  **Django 서버 (`views.py`):** 파일을 받아 AWS S3 버킷에 업로드하고, 고유한 `s3_object_key`를 생성합니다.
4.  **응답:** Django 서버는 이 `s3_object_key`를 JSON 형태로 `chatbot.html`에 돌려줍니다.
5.  **세션 저장:** `chatbot.html`의 JavaScript는 받은 `s3_object_key`를 브라우저의 `sessionStorage`에 저장하여, 현재 세션 동안 이 파일을 계속 참조할 수 있도록 합니다.

**2단계: 질문 및 분석**

1.  **사용자:** `chatbot.html`의 입력창에 파일 데이터에 대한 질문(예: "가장 높은 매출을 기록한 제품은?")을 입력하고 전송합니다.
2.  **프론트엔드 (`chatbot.html`):** JavaScript는 사용자의 메시지와 `sessionStorage`에 저장된 `s3_object_key`를 함께 FastAPI 서버의 `/chat/` 엔드포인트로 전송합니다.
3.  **FastAPI 서버 (`main.py`):** 요청을 받아 메시지와 `s3_object_key`를 `analyze_csv_data` 함수(`tools.py`에 위치)로 전달합니다.
4.  **데이터 분석 (`tools.py`):**
    a.  `download_script.py`를 실행하여 `s3_object_key`를 이용해 S3에서 CSV 파일을 서버로 다운로드합니다.
    b.  AI에게 사용자의 질문과 파일의 구조(스키마, 일부 데이터)를 보내, `pandas`를 사용한 데이터 분석 Python 코드를 생성하도록 요청합니다.
    c.  생성된 코드를 서버에서 직접 실행하여 분석 결과(예: 특정 값, 통계)를 얻습니다.
    d.  이 분석 결과를 다시 AI에게 보내, 사용자가 이해하기 쉬운 자연스러운 한국어 문장으로 된 최종 답변을 생성하도록 합니다.
5.  **답변 스트리밍:** FastAPI 서버는 생성된 답변을 프론트엔드로 실시간 스트리밍하여 전송하고, 사용자는 `chatbot.html` 화면에서 AI의 답변을 즉시 확인할 수 있습니다.

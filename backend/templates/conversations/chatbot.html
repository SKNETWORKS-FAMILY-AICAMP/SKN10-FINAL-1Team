<html><head>
    <meta charset="utf-8"/>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Inter%3Awght%40400%3B500%3B700%3B900&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <title>Stitch Design</title>
    <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style type="text/tailwindcss">
        :root {
          --primary-color: #0b80ee;
          --secondary-color: #f0f2f5;
          --text-primary: #111518;
          --text-secondary: #60768a;
          --border-color: #dbe1e6;
        }
        body {
          font-family: Inter, "Noto Sans", sans-serif;
        }
        .sidebar-item:hover {
          background-color: var(--secondary-color);
        }
        .sidebar-item.active {
          background-color: var(--secondary-color);
        }
        .dropdown:hover .dropdown-menu {
          display: block;
        }
        .dropdown-menu.show {
            display: block;
        }
        /* Styles for closed sidebar */
        .sidebar-closed {
            width: 60px !important; /* Width to accommodate the button */
            padding-left: 0 !important;
            padding-right: 0 !important;
            border-right-width: 1px !important; /* Optional: keep border consistent */
            /* overflow: hidden !important; */ /* Commented out to allow button visibility */
            display: flex; /* Use flex to manage the layout of the top panel */
            flex-direction: column;
            align-items: center; /* Center the top panel (and thus the button) */
        }
        /* Hide direct children of .sidebar-closed, EXCEPT for #sidebar-top-panel */
        .sidebar-closed > *:not(#sidebar-top-panel) {
            display: none !important;
        }
        /* Specific styles for #sidebar-top-panel when sidebar is closed */
        .sidebar-closed > #sidebar-top-panel {
            padding: 0.25rem !important; /* Minimal padding around the button */
            border-bottom-width: 0 !important; /* Hide border if any */
            width: 100%; /* Ensure the top panel takes the full width of the collapsed sidebar */
        }
        /* Hide the H1 title within the top panel when sidebar is closed */
        .sidebar-closed > #sidebar-top-panel h1 {
            display: none !important;
        }
        /* Ensure the toggle button within the top panel is visible and centered */
        .sidebar-closed > #sidebar-top-panel #toggle-sidebar {
            display: flex !important; 
            justify-content: center;
            align-items: center;
            margin: 0 auto !important; /* Center the button horizontally within the top panel */ 
            padding: 0.25rem !important; /* Consistent padding */
            width: auto; /* Allow button to size to its icon */
        }
        /* Ensure the icon inside the toggle button is visible */
        .sidebar-closed > #sidebar-top-panel #toggle-sidebar > .material-icons-outlined {
            display: inline-block !important;
        }
      </style>
    </head>
    <body>
    <div class="relative flex size-full min-h-screen flex-col bg-white group/design-root overflow-x-hidden">
    <div id="header-placeholder"></div>
    <div class="flex h-full grow">
    <aside class="w-80 bg-slate-50 border-r border-[var(--border-color)] flex flex-col transition-all duration-300 ease-in-out shrink-0 max-h-[calc(100vh-4rem)] md:sticky md:top-16">
    <div class="p-4 border-b border-[var(--border-color)]" id="sidebar-top-panel">
    <div class="flex items-center justify-between">
    <h1 class="text-[var(--text-primary)] text-xl font-semibold">Chatbot</h1>
    <button class="p-1 rounded-md hover:bg-[var(--secondary-color)] text-[var(--text-secondary)]" id="toggle-sidebar">
    <span class="material-icons-outlined">menu_open</span>
    </button>
    </div>
    </div>
    <div class="flex flex-col gap-2 p-4 overflow-y-auto flex-grow">
    <button class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-[var(--text-primary)] hover:bg-[var(--secondary-color)] transition-colors duration-150">
    <span class="material-icons text-[var(--primary-color)]">add_circle</span>
    <p class="text-sm font-medium">New chat</p>
    </button>
    <div class="flex items-center justify-between mt-4 mb-1 px-3">
    <h2 class="text-xs text-[var(--text-secondary)] font-semibold uppercase">Recent Chats</h2>
    <div class="relative">
    <button class="p-1 rounded-md hover:bg-slate-200 text-[var(--text-secondary)]" id="sort-button">
    <span class="material-icons-outlined text-base">sort</span>
    </button>
    <ul class="absolute hidden right-0 mt-1 w-40 bg-white border border-[var(--border-color)] rounded-md shadow-lg z-10" id="sort-menu">
    <li><a class="block px-3 py-1.5 text-sm text-[var(--text-primary)] hover:bg-[var(--secondary-color)]" data-sort="recent" href="#">최신순</a></li>
    <li><a class="block px-3 py-1.5 text-sm text-[var(--text-primary)] hover:bg-[var(--secondary-color)]" data-sort="oldest" href="#">오래된순</a></li>
    <li><a class="block px-3 py-1.5 text-sm text-[var(--text-primary)] hover:bg-[var(--secondary-color)]" data-sort="name_asc" href="#">이름 오름차순</a></li>
    <li><a class="block px-3 py-1.5 text-sm text-[var(--text-primary)] hover:bg-[var(--secondary-color)]" data-sort="name_desc" href="#">이름 내림차순</a></li>
    </ul>
    </div>
    </div>
    <div class="flex flex-col gap-1 px-2">
        {% for session in sessions %}
        <a class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-[var(--text-primary)] {% if session.id == active_session_id %}active bg-[var(--secondary-color)]{% else %}hover:bg-[var(--secondary-color)]{% endif %} transition-colors duration-150" href="javascript:void(0);" data-session-id="{{ session.id }}">
            {% if session.agent_type == 'CODING' %}
            <span class="material-icons-outlined text-blue-500">code</span>
            {% elif session.agent_type == 'DATA_ANALYSIS' %}
            <span class="material-icons-outlined text-green-500">analytics</span>
            {% elif session.agent_type == 'DOC_ANALYSIS' %}
            <span class="material-icons-outlined text-purple-500">description</span>
            {% elif session.agent_type == 'PREDICTION' %}
            <span class="material-icons-outlined text-orange-500">model_training</span>
            {% else %}
            <span class="material-icons-outlined text-gray-500">smart_toy</span>
            {% endif %}
            <p class="text-sm font-medium">{{ session.title|default:"New Chat" }}</p>
        </a>
        {% empty %}
        <p class="px-3 py-2 text-sm text-gray-500">No recent chats.</p>
        {% endfor %}
    </div>
    <div class="p-4 border-t border-[var(--border-color)]">
    <a class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-[var(--text-primary)] hover:bg-[var(--secondary-color)] transition-colors duration-150" href="#">
    <span class="material-icons-outlined text-[var(--text-secondary)]">help_outline</span>
    <p class="text-sm font-medium">FAQ</p>
    </a>
    <a class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-[var(--text-primary)] hover:bg-[var(--secondary-color)] transition-colors duration-150" href="{% url 'accounts:settings' %}">
    <span class="material-icons-outlined text-[var(--text-secondary)]">settings</span>
    <p class="text-sm font-medium">Settings</p>
    </a>
    </div>
    </aside>
    <main class="flex flex-1 flex-col bg-white max-h-[calc(100vh-4rem)]">
    <div class="flex-grow flex flex-col items-center p-6 pb-0">
    <div class="flex-grow flex flex-col items-center w-full">
    <div id="message-list" class="w-full max-w-3xl flex flex-col justify-end flex-grow">
        {% for message in initial_messages %}
            <div class="flex flex-col mb-4 {% if message.role == 'user' %}items-end{% else %}items-start{% endif %}">
                <div class="p-3 rounded-lg max-w-xl break-words {% if message.role == 'user' %}bg-blue-500 text-white{% else %}bg-gray-200 text-gray-800{% endif %}">
                    {{ message.content|escape|linebreaksbr }}
                </div>
                {% if message.role == 'assistant' %}
                <div class="flex items-center gap-2 self-start mt-2">
                    <button class="p-1.5 rounded-md hover:bg-gray-300 text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                        <span class="material-icons-outlined text-sm">content_copy</span>
                    </button>
                    <button class="p-1.5 rounded-md hover:bg-gray-300 text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                        <span class="material-icons-outlined text-sm">thumb_up</span>
                    </button>
                    <button class="p-1.5 rounded-md hover:bg-gray-300 text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                        <span class="material-icons-outlined text-sm">thumb_down</span>
                    </button>
                </div>
                {% endif %}
            </div>
        {% empty %}
            <div class="flex flex-col items-start mb-4">
                <div class="bg-gray-200 text-gray-800 p-3 rounded-lg max-w-xl break-words">
                    안녕하세요! 무엇을 도와드릴까요?
                </div>
                <div class="flex items-center gap-2 self-start mt-2">
                    <button class="p-1.5 rounded-md hover:bg-gray-300 text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                        <span class="material-icons-outlined text-sm">content_copy</span>
                    </button>
                    <button class="p-1.5 rounded-md hover:bg-gray-300 text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                        <span class="material-icons-outlined text-sm">thumb_up</span>
                    </button>
                    <button class="p-1.5 rounded-md hover:bg-gray-300 text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">
                        <span class="material-icons-outlined text-sm">thumb_down</span>
                    </button>
                </div>
            </div>
        {% endfor %}
    </div>
    <div class="text-center mb-12 mt-auto pt-12">
    <span class="material-icons text-6xl text-[var(--primary-color)] mb-4">smart_toy</span>
    <h2 class="text-[var(--text-primary)] tracking-light text-3xl font-bold leading-tight">How can I help you today?</h2>
    </div>
    </div>
    </div>
    </div>
    <div class="sticky bottom-0 bg-white/80 backdrop-blur-md border-t border-[var(--border-color)] p-4 md:p-6">
    <div class="max-w-3xl mx-auto">
    <div class="relative flex items-end gap-2">
    <div class="dropdown relative">
    <button class="bg-white text-[var(--text-secondary)] hover:text-[var(--text-primary)] font-medium p-2.5 rounded-lg border border-[var(--border-color)] hover:border-[var(--primary-color)] focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] flex items-center justify-center size-11">
    <span class="material-icons-outlined text-gray-500 text-xl">smart_toy</span>
    </button>
    <ul class="dropdown-menu absolute hidden text-[var(--text-primary)] pt-1 min-w-[180px] bg-white border border-[var(--border-color)] rounded-lg shadow-lg z-10 bottom-full mb-2">
    <li><a class="rounded-t-lg hover:bg-[var(--secondary-color)] py-2 px-4 block whitespace-no-wrap flex items-center gap-2 text-sm" href="#"><span class="material-icons-outlined text-blue-500">code</span> 코딩 세션</a></li>
    <li><a class="hover:bg-[var(--secondary-color)] py-2 px-4 block whitespace-no-wrap flex items-center gap-2 text-sm" href="#"><span class="material-icons-outlined text-green-500">analytics</span> 분석 세션</a></li>
    <li><a class="hover:bg-[var(--secondary-color)] py-2 px-4 block whitespace-no-wrap flex items-center gap-2 text-sm" href="#"><span class="material-icons-outlined text-purple-500">description</span> 문서 세션</a></li>
    <li><a class="hover:bg-[var(--secondary-color)] py-2 px-4 block whitespace-no-wrap flex items-center gap-2 text-sm" href="#"><span class="material-icons-outlined text-orange-500">model_training</span> 예측 세션</a></li>
    <li><a class="rounded-b-lg hover:bg-[var(--secondary-color)] py-2 px-4 block whitespace-no-wrap flex items-center gap-2 text-sm" href="#"><span class="material-icons-outlined text-gray-500">smart_toy</span> Auto 세션</a></li>
    </ul>
    </div>
    <textarea id="chat-message-input" class="form-input flex-1 resize-none overflow-hidden rounded-xl text-[var(--text-primary)] focus:outline-0 focus:ring-2 focus:ring-[var(--primary-color)] border border-[var(--border-color)] bg-white focus:border-[var(--primary-color)] min-h-12 max-h-48 placeholder:text-[var(--text-secondary)] p-3 pr-20 text-sm font-normal leading-normal" placeholder="Type your message here..." rows="1" style="padding-right: 5.5rem;"></textarea>
    <div class="absolute right-2 bottom-2 flex items-center gap-2">
    <button aria-label="Attach file" class="flex items-center justify-center size-9 rounded-lg hover:bg-[var(--secondary-color)] text-[var(--text-secondary)] hover:text-[var(--primary-color)] transition-colors duration-150">
    <span class="material-icons-outlined text-xl">attach_file</span>
    </button>
    <button id="send-message-button" aria-label="Send message" class="flex items-center justify-center size-9 rounded-lg bg-[var(--primary-color)] text-white hover:bg-opacity-90 transition-colors duration-150">
    <span class="material-icons text-xl">send</span>
    </button>
    </div>
    </div>
    <p class="text-xs text-[var(--text-secondary)] text-center mt-2">Chatbot may produce inaccurate information.</p>
    </div>
    </div>
    </main>
    </div>
    </div>
    <script>
        const toggleSidebarButton = document.getElementById('toggle-sidebar');
        const openSidebarMobileButton = document.getElementById('open-sidebar-mobile'); // Kept for loadHeader logic
        const sidebar = document.querySelector('aside');

        function toggleSidebar() {
            const isCurrentlyClosed = sidebar.classList.contains('sidebar-closed');
            const toggleIcon = toggleSidebarButton.querySelector('.material-icons-outlined');

            if (isCurrentlyClosed) { // Action: OPEN sidebar
                sidebar.classList.remove('sidebar-closed');
                if (toggleIcon) toggleIcon.textContent = 'menu_open';
                
                if (window.innerWidth < 768) {
                    // Mobile: Apply overlay and specific layout for open mobile sidebar
                    sidebar.classList.add('absolute', 'z-20', 'bg-slate-50', 'h-full', 'max-h-full', 'top-0');
                    sidebar.classList.remove('max-h-[calc(100vh-4rem)]', 'md:sticky', 'md:top-16');
                    
                    const overlay = document.createElement('div');
                    overlay.classList.add('fixed', 'inset-0', 'bg-black/30', 'z-10', 'md:hidden');
                    overlay.id = 'sidebar-overlay';
                    document.body.appendChild(overlay);
                    overlay.addEventListener('click', () => {
                        toggleSidebar(); // This will call close logic
                        overlay.remove();
                    });
                }
            } else { // Action: CLOSE sidebar
                sidebar.classList.add('sidebar-closed');
                if (toggleIcon) toggleIcon.textContent = 'menu';
                
                if (window.innerWidth < 768) {
                    // Mobile: Remove overlay and restore default/desktop-like layout classes before hiding
                    const overlay = document.getElementById('sidebar-overlay');
                    if (overlay) overlay.remove();
                    
                    sidebar.classList.remove('absolute', 'z-20', 'bg-slate-50', 'h-full', 'max-h-full', 'top-0');
                    sidebar.classList.add('max-h-[calc(100vh-4rem)]', 'md:sticky', 'md:top-16');
                }
            }
        }

        if (toggleSidebarButton) {
            toggleSidebarButton.addEventListener('click', toggleSidebar);
        }

        const textarea = document.querySelector('textarea');
        if (textarea) {
            textarea.addEventListener('input', () => {
              textarea.style.height = 'auto';
              textarea.style.height = textarea.scrollHeight + 'px';
            });
        }

        // Initial sidebar state on page load for mobile
        if (window.innerWidth < 768) {
          if (!sidebar.classList.contains('sidebar-closed')) {
            // If not already closed by default (e.g. via HTML class), close it
            toggleSidebar(); 
          }
        } else {
            // Ensure sidebar is not closed by default on desktop if it was previously left in mobile closed state
            // And also ensure the icon is correct if it starts open
            if (sidebar.classList.contains('sidebar-closed')) {
                // If it has sidebar-closed, remove it for desktop initial view
                // sidebar.classList.remove('sidebar-closed'); 
                // Decided against auto-opening on desktop load if class is present.
                // Instead, ensure icon is correct if it IS closed.
                const toggleIcon = toggleSidebarButton.querySelector('.material-icons-outlined');
                if (toggleIcon) toggleIcon.textContent = 'menu';
            } else {
                const toggleIcon = toggleSidebarButton.querySelector('.material-icons-outlined');
                if (toggleIcon) toggleIcon.textContent = 'menu_open';
            }
        }

        // Dropdown logic
        const dropdownButton = document.querySelector('.dropdown button');
        const dropdownMenu = document.querySelector('.dropdown-menu');
        if (dropdownButton && dropdownMenu) {
            const dropdownItems = dropdownMenu.querySelectorAll('a');
            const selectedSessionIcon = dropdownButton.querySelector('span.material-icons-outlined');
            
            dropdownItems.forEach(item => {
              item.addEventListener('click', function(e) {
                e.preventDefault();
                const icon = this.querySelector('.material-icons-outlined');
                if (selectedSessionIcon && icon) {
                    selectedSessionIcon.textContent = icon.textContent;
                    selectedSessionIcon.className = icon.className + ' text-xl'; 
                }
                dropdownMenu.classList.add('hidden');
              });
            });
            
            document.addEventListener('click', function(event) {
              if (!dropdownButton.contains(event.target) && !dropdownMenu.contains(event.target)) {
                dropdownMenu.classList.add('hidden');
              }
            });
            
            dropdownButton.addEventListener('click', () => {
                dropdownMenu.classList.toggle('hidden');
            });
        }

        // Sort button logic
        const sortButton = document.getElementById('sort-button');
        const sortMenu = document.getElementById('sort-menu');
        if (sortButton && sortMenu) {
            sortButton.addEventListener('click', (event) => {
                event.stopPropagation();
                sortMenu.classList.toggle('hidden');
            });
            document.addEventListener('click', (event) => {
                if (!sortMenu.contains(event.target) && !sortButton.contains(event.target)) {
                    sortMenu.classList.add('hidden');
                }
            });
            sortMenu.querySelectorAll('a').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Sort by:', e.target.dataset.sort);
                    sortMenu.classList.add('hidden');
                });
            });
        }
    </script>
    <script>
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function (match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            const messageList = document.getElementById('message-list');
            const sessionLinks = document.querySelectorAll('.sidebar-item[data-session-id]');
            const mainContent = document.querySelector('main');

            function scrollToBottom() {
                mainContent.scrollTop = mainContent.scrollHeight;
            }

            function renderMessages(messages, append = false) {
                if (!append) {
                    while (messageList.firstChild) {
                        messageList.removeChild(messageList.firstChild);
                    }
                }

                if (!append && messages.length === 0) {
                    messageList.innerHTML = `
                        <div class="flex-grow flex items-center justify-center">
                            <div class="text-center">
                                <div class="text-4xl text-gray-300 mb-2">🤖</div>
                                <p class="text-[var(--text-primary)] text-sm">메시지가 없습니다. 새로운 대화를 시작해보세요.</p>
                            </div>
                        </div>`;
                    return;
                }

                const placeholder = messageList.querySelector('.placeholder-message');
                if (append && placeholder) {
                    placeholder.remove();
                }

                messages.forEach(message => {
                    const messageWrapper = document.createElement('div');
                    messageWrapper.classList.add('flex', 'flex-col', 'mb-4');

                    const messageBubble = document.createElement('div');
                    messageBubble.classList.add('p-3', 'rounded-lg', 'max-w-xl', 'break-words');
                    messageBubble.innerHTML = escapeHTML(message.content).replace(/\n/g, '<br>');

                    if (message.role === 'user') {
                        messageWrapper.classList.add('items-end');
                        messageBubble.classList.add('bg-blue-500', 'text-white');
                    } else { // assistant or system
                        messageWrapper.classList.add('items-start');
                        messageBubble.classList.add('bg-gray-200', 'text-gray-800');
                    }

                    messageWrapper.appendChild(messageBubble);

                    if (message.role === 'assistant') {
                        const actionsWrapper = document.createElement('div');
                        actionsWrapper.className = "flex items-center gap-2 self-start mt-2";
                        
                        const icons = ['content_copy', 'thumb_up', 'thumb_down'];
                        icons.forEach(iconName => {
                            const button = document.createElement('button');
                            button.className = "p-1.5 rounded-md hover:bg-gray-300 text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors";
                            
                            const span = document.createElement('span');
                            span.className = "material-icons-outlined text-sm";
                            span.textContent = iconName;
                            
                            button.appendChild(span);
                            actionsWrapper.appendChild(button);
                        });
                        
                        messageWrapper.appendChild(actionsWrapper);
                    }

                    messageList.appendChild(messageWrapper);
                });
                scrollToBottom();
            }

            async function fetchAndRenderMessages(sessionId) {
                if (!sessionId) return;
                try {
                    const response = await fetch(`/conversations/api/sessions/${sessionId}/messages/`, { credentials: 'include' });
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const messages = await response.json();
                    renderMessages(messages);
                } catch (error) {
                    console.error('Error fetching messages:', error);
                    messageList.innerHTML = `<div class="text-red-500 text-center p-4">메시지를 불러오는데 실패했습니다.</div>`;
                }
            }

            sessionLinks.forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    const sessionId = this.dataset.sessionId;

                    // Update active state in sidebar
                    sessionLinks.forEach(l => {
                        l.classList.remove('active', 'bg-[var(--secondary-color)]');
                        if (!l.classList.contains('hover:bg-[var(--secondary-color)]')) {
                           l.classList.add('hover:bg-[var(--secondary-color)]');
                        }
                    });
                    this.classList.add('active', 'bg-[var(--secondary-color)]');
                    this.classList.remove('hover:bg-[var(--secondary-color)]');

                    // Fetch and render messages for the new session
                    fetchAndRenderMessages(sessionId);
                });
            });
            // Initial scroll to bottom
            scrollToBottom();

            const messageInput = document.getElementById('chat-message-input');
            const sendButton = document.getElementById('send-message-button');

            function getActiveSessionId() {
                const activeSession = document.querySelector('.sidebar-item.active');
                return activeSession ? activeSession.dataset.sessionId : null;
            }

            async function sendMessage() {
                const content = messageInput.value.trim();
                if (!content) return;

                const sessionId = getActiveSessionId();
                if (!sessionId) {
                    console.error('No active session selected.');
                    // Optionally, create a new session here or alert the user
                    return;
                }

                // Temporarily render user message for responsiveness
                const tempUserMessage = { role: 'user', content: content };
                renderMessages([tempUserMessage], true);
                messageInput.value = '';
                messageInput.style.height = 'auto';

                try {
                    const response = await fetch(`/conversations/api/sessions/${sessionId}/messages/`, { 
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ content: content }),
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const newMessages = await response.json();

                    // Remove the temporary user message before rendering the final ones
                    const lastMessage = messageList.lastChild;
                    if(lastMessage) lastMessage.remove();

                    renderMessages(newMessages, true); // Append new messages from server

                } catch (error) {
                    console.error('Error sending message:', error);
                    // Optionally, show an error message in the UI
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'text-red-500 text-sm text-center my-2';
                    errorDiv.textContent = 'Failed to send message. Please try again.';
                    messageList.appendChild(errorDiv);
                    scrollToBottom();
                }
            }

            sendButton.addEventListener('click', sendMessage);

            messageInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            });

            // Auto-resize textarea
            messageInput.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        });
    </script>
    <script>
        function loadHeader() {
            fetch('/_header.html') // Adjusted path for templates in subdirectories
                .then(response => response.text())
                .then(data => {
                    document.getElementById('header-placeholder').innerHTML = data;
                    // Set active link
                    const currentPage = window.location.pathname.split('/').pop().replace('.html', '');
                    const navLink = document.querySelector(`nav a[data-navlink='${currentPage || 'chatbot'}']`);
                    if (navLink) {
                        navLink.classList.add('text-[var(--text-primary)]', 'bg-[var(--secondary-color)]');
                        navLink.classList.remove('text-[var(--text-secondary)]');
                    }

                    // Re-attach event listener for mobile sidebar toggle if it's defined in this page's main script
                    const openSidebarMobileButton = document.getElementById('open-sidebar-mobile');
                    if (typeof openMobileSidebar === 'function' && openSidebarMobileButton) { // Check if openMobileSidebar is defined
                         openSidebarMobileButton.addEventListener('click', openMobileSidebar);
                    } else if (typeof toggleSidebar === 'function' && openSidebarMobileButton) {
                        // When on a page with toggleSidebar (like chatbot.html), make the header's mobile toggle button use it.
                        openSidebarMobileButton.addEventListener('click', toggleSidebar);
                    }
                })
                .catch(error => console.error('Error loading header:', error));
        }
        document.addEventListener('DOMContentLoaded', loadHeader);
    </script>
    </body></html>

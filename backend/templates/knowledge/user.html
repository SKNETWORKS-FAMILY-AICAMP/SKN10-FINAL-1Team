<div class="p-8">
    <div class="mx-auto max-w-4xl">
    <!-- alpine.js ÏûÑÌè¨Ìä∏-->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
    <!-- alpine.js ÏûÑÌè¨Ìä∏--> 
    <section x-data="{
        // ÌòÑÏû¨ Ïó¥Î†§ ÏûàÎäî Î™®Îã¨ Íµ¨Î∂Ñ: 'add' | 'delete' | 'multi' | null
        active: null,
        // Í≥µÌÜµ ÏÉÅÌÉú
        loading: false, error: '',
        // Î™®Îã¨Î≥Ñ Ìèº Îç∞Ïù¥ÌÑ∞
        add:    { email:'', pw:'', pw_confirm:'', username:'' },
        del:    { email:'' },
        // Î™®Îã¨ Ïó¥Í≥† Îã´Í∏∞
        open(name) { this.active = name},
        close() { 
            this.active = null
            this.error = ''
        },
        submitDelete(event) {
            if (!this.del.email) {
                this.error = 'Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!'
            }
            else {
                // ÌôïÏù∏Ï∞Ω ÎùÑÏö∞Í∏∞
                if (confirm('‚ö†Ô∏è Ï†ïÎßê Ïù¥ Í≥ÑÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    this.loading = true
                    this.$nextTick(() => event.target.submit())
                }   
            }
        },
        submitAdd(event) {
            if (!this.add.email) {
                this.error = 'Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!'
            } else if (!this.add.pw) {
                this.error = 'ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!'
            } else if (!this.add.pw_confirm) {
                this.error = 'ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!'
            } else if (this.add.pw !== this.add.pw_confirm) {
                this.error = 'Îëê ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏïÑÏöî!'
            } else if (!this.add.username) {
                this.error = 'ÏÇ¨Ïö©ÏûêÎ™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!'
            } else {
                // ÌôïÏù∏Ï∞Ω ÎùÑÏö∞Í∏∞
                if (confirm('‚ö†Ô∏è Ï†ïÎßê Ïù¥ Í≥ÑÏ†ïÏùÑ Ï∂îÍ∞ÄÌï†ÍπåÏöî?')) {
                    this.loading = true
                    this.$nextTick(() => event.target.submit())
                }   
            }
        },
        submitMultiAdd(event) {
            // 1) ÌååÏùº Ï≤¥ÌÅ¨
            if (!$refs.fileInput.files.length) {
                this.error = 'Ïò§Î•ò : ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï§ò!'
                return
            }
            // 1-1) CSV ÌôïÏû•Ïûê Ï≤¥ÌÅ¨
            const file = $refs.fileInput.files[0];
            const name = file.name.toLowerCase();
            if (!name.endsWith('.csv')) {
                this.error = 'Ïò§Î•ò : CSV ÌååÏùºÎßå ÏóÖÎ°úÎìúÌï† Ïàò ÏûàÏñ¥!';
                return;
            }
            // 3) ÌôïÏù∏Ï∞Ω
            if (!confirm(`‚ö†Ô∏è Ï†ïÎßê Îã§Ï§ë Í≥ÑÏ†ïÏùÑ Ï∂îÍ∞ÄÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                return
            }
            // 4) Î™®Îëê ÌÜµÍ≥ºÌïòÎ©¥ Î°úÎî© ÏºúÍ≥† Ìèº Ï†úÏ∂ú
            this.loading = true
            $refs.multiForm.submit()
        },
    }"
    class="rounded-lg bg-white p-6 shadow-md border border-gray-200">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-[var(--text-primary)] text-2xl font-semibold leading-tight tracking-[-0.015em]">ÏÇ¨Ïö©Ïûê Î™©Î°ù</h3>
        <div class="flex items-center gap-4 ml-auto">
        
        <!-- Í≥ÑÏ†ï ÏÇ≠Ï†ú Alpine Ïª¥Ìè¨ÎÑåÌä∏ ÏãúÏûë -->
        <div class="relative">

        <!-- 1) Í≥ÑÏ†ï ÏÇ≠Ï†ú Î≤ÑÌäº -->
        <button
            @click="open('delete')"
            class="flex items-center gap-3 rounded-full px-6 py-1.5 bg-orange-400 hover:bg-orange-600 text-black"
        ><span class="material-icons-outlined font-bold">Í≥ÑÏ†ï ÏÇ≠Ï†ú</span></button>

        <!-- 2) Í≥ÑÏ†ï ÏÇ≠Ï†ú Î™®Îã¨ Î∞ïÏä§ -->
        <div
            x-show="active === 'delete'"
            class="fixed inset-0 flex items-center justify-center z-50 p-4"
            x-cloak
        >
            <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
            <div class="flex justify-between items-center px-6 py-4 border-b">
                <h2 class="text-lg font-semibold">Í≥ÑÏ†ï ÏÇ≠Ï†ú</h2>
                <button @click="close()" class="text-xl leading-none">&times;</button>
            </div>

            <form
                action="{% url 'knowledge:delete_user' %}"
                method="post"
                class="px-6 py-4 space-y-4"
                @submit.prevent="submitDelete($event)">
                {% csrf_token %}

                <!-- ÏóêÎü¨ Î©îÏãúÏßÄ -->
                <div x-show="error"
                class="flex items-start space-x-2 bg-red-50 border-l-4 border-red-600 text-red-700 p-3 rounded-md shadow-sm mt-2">
                <!-- Ïã§Ï†ú Î©îÏãúÏßÄ -->
                <span x-text="error" class="text-sm"></span>
                </div>
                
                <div>
                <label class="block text-sm font-medium">üÜî<span class="text-red-500"> ÏÇ≠Ï†úÌï† Ïù¥Î©îÏùº</span>ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî! </label>
                <input type="email" name="email" x-model="del.email" class="mt-1 w-full border rounded px-3 py-2" />
                </div>
    
                <div class="text-right space-x-2">
                <button type="button" @click="close()" class="px-4 py-2 rounded border hover:bg-gray-100">Ï∑®ÏÜå</button>
                <button type="submit" class="px-4 py-2 rounded bg-red-500 hover:bg-red-700 text-white">ÏÇ≠Ï†ú</button>
                </div>
            </form>
            </div>
        </div>
        </div>
        <!-- Í≥ÑÏ†ï ÏÇ≠Ï†ú Alpine Ïª¥Ìè¨ÎÑåÌä∏ ÎÅù -->

        
        <!-- Í≥ÑÏ†ï Ï∂îÍ∞Ä Alpine Ïª¥Ìè¨ÎÑåÌä∏ ÏãúÏûë -->
        <div class="relative">
        <!-- 1) Í≥ÑÏ†ï Ï∂îÍ∞Ä Î≤ÑÌäº -->

        <button
            @click="open('add')"
            class="flex items-center gap-3 rounded-full px-6 py-1.5 bg-orange-400 hover:bg-orange-600 text-black"
        ><span class="material-icons-outlined font-bold">Í≥ÑÏ†ï Ï∂îÍ∞Ä</span></button>

        <!-- 2) Í≥ÑÏ†ï Ï∂îÍ∞Ä Î™®Îã¨ Î∞ïÏä§ -->
        <div x-show="active === 'add'" class="fixed inset-0 flex items-center justify-center z-50 p-4" x-cloak>
            <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
            <div class="flex justify-between items-center px-6 py-4 border-b">
                <h2 class="text-lg font-semibold">Í≥ÑÏ†ï Ï∂îÍ∞Ä</h2>
                <button @click="close()" class="text-xl leading-none">&times;</button>
            </div>


            <form
                action="{% url 'knowledge:create_user' %}"
                method="post"
                class="px-6 py-4 space-y-4"
                @submit.prevent="submitAdd($event)">
                {% csrf_token %}
                
                <!-- ÏóêÎü¨ Î©îÏãúÏßÄ -->
                <div
                x-show="error"
                class="flex items-start space-x-2 bg-red-50 border-l-4 border-red-600 text-red-700 p-3 rounded-md shadow-sm mt-2"
                >
                <!-- Ïã§Ï†ú Î©îÏãúÏßÄ -->
                <span x-text="error" class="text-sm"></span>
                </div>

                <div>
                <label class="block text-sm font-medium">Ïù¥Î©îÏùº</label>
                <input type="email" name="email"
                x-model="add.email"
                @input="error = ''"
                class="mt-1 w-full border rounded px-3 py-2" />
                </div>

                <div>
                <label class="block text-sm font-medium">ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                <input type="password" name="pw"
                x-model="add.pw"
                @input="error = ''"
                class="mt-1 w-full border rounded px-3 py-2" />
                </div>

                <div>
                <label class="block text-sm font-medium">ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏</label>
                <input type="password" name="pw_confirm"
                x-model="add.pw_confirm"
                @input="error = ''"
                class="mt-1 w-full border rounded px-3 py-2" />
                </div>

                <div>
                <label class="block text-sm font-medium">ÏÇ¨Ïö©ÏûêÎ™Ö</label>
                <input name="username"
                x-model="add.username"
                @input="error = ''"
                class="mt-1 w-full border rounded px-3 py-2" />
                </div>

                <div>
                <label class="block text-sm font-medium">Í∂åÌïú</label>
                <select id="authority" name="authority" class="w-full border rounded p-2">
                    <option value="admin">admin</option>
                    <option value="employee">employee</option>
                    <option value="guest">guest</option>
                </select>
                </div>

                <div>
                <label class="block text-sm font-medium">Î∂ÄÏÑú</label>
                <select id="department" name="department" class="w-full border rounded p-2">
                    <option value="development">development</option>
                    <option value="business_strategy">business_strategy</option>
                    <option value="customer_management">customer_management</option>
                    <option value="administrator">administrator</option>
                </select>
                </div>


                <div class="text-right space-x-2">
                <button type="button" @click="close()" class="px-4 py-2 rounded border hover:bg-gray-100">Ï∑®ÏÜå</button>
                <button type="submit" class="px-4 py-2 rounded bg-orange-400 hover:bg-orange-600 text-white">Ï∂îÍ∞Ä</button>
                </div>
            </form>
            </div>
        </div>
        </div>
        <!-- Alpine Ïª¥Ìè¨ÎÑåÌä∏ ÎÅù -->

        <!-- Îã§Ï§ë Í≥ÑÏ†ï Ï∂îÍ∞Ä Alpine Ïª¥Ìè¨ÎÑåÌä∏ ÏãúÏûë -->
        <div class="relative">

        <!-- 1) Îã§Ï§ë Í≥ÑÏ†ï ÏÉùÏÑ± Î≤ÑÌäº -->
        <button 
        @click="open('multi')"
        class="flex items-center gap-3 rounded-full px-6 py-1.5 bg-orange-400 hover:bg-orange-600 text-black"
        ><span class="material-icons-outlined font-bold">Îã§Ï§ë Í≥ÑÏ†ï Ï∂îÍ∞Ä</span></button>

        <!-- 2) Îã§Ï§ë Í≥ÑÏ†ï Î™®Îã¨ Î∞ïÏä§ -->
        <div x-show="active === 'multi'" class="fixed inset-0 flex items-center justify-center z-50 p-4" x-cloak>
            <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
            <div class="flex justify-between items-center px-6 py-4 border-b">
                <h2 class="text-lg font-semibold">Îã§Ï§ë Í≥ÑÏ†ï Ï∂îÍ∞Ä</h2>
                <button @click="close()" class="text-xl leading-none">&times;</button>
            </div>
            
            <!-- Ï£ºÏùòÏÇ¨Ìï≠ -->
            <p class="flex text-sm items-start space-x-2 bg-red-50 text-red-700 p-3 rounded-md shadow-sm m-4 ">
                ‚ÄªÏ£ºÏùòÏÇ¨Ìï≠ :<br>
                1. ÏûÖÎ†• ÌååÏùºÏùÄ csvÌååÏùºÏù¥Ïñ¥Ïïº Ìï®. <br>
                2. name, id, authority, department Ïª¨ÎüºÏúºÎ°ú Íµ¨ÏÑ±ÎêòÏñ¥Ïïº Ìï®.<br>
                3. Ïª¨ÎüºÍ∞íÏùÄ nullÍ∞íÏù¥ ÏóÜÏñ¥Ïïº Ìï®.  
            </p>

            <form
                action="{% url 'knowledge:create_multi_user' %}"
                method="post"
                class="px-6 space-y-4"
                enctype="multipart/form-data"
                x-ref="multiForm"
                @submit.prevent="submitMultiAdd()">
                {% csrf_token %}

                <div>
                <label class="block text-sm font-medium">üìÇ Ï∂îÍ∞ÄÌï† ÏßÅÏõêÎì§Ïùò Ï†ïÎ≥¥Í∞Ä Îã¥Í∏¥ csvÌååÏùºÏùÑ ÎÑ£Ïñ¥Ï£ºÏÑ∏Ïöî! </label>
                <input type="file" name="file" x-ref="fileInput" class="mt-2 w-full border rounded px-3 py-2" />
                </div>
    
                <!-- ÏóêÎü¨ Î©îÏãúÏßÄ -->
                <p x-show="error" x-text="error" class="text-red-600 text-sm mt-2"></p>

                <div class="text-right space-x-2">
                <button type="button" @click="close()" class="px-4 py-2 rounded border hover:bg-gray-100">Ï∑®ÏÜå</button>
                <button type="submit" class="px-4 py-2 rounded bg-red-500 hover:bg-red-700 text-white">ÏÉùÏÑ±</button>
                </div>
                
            </form>
            </div>
        </div>
        </div>
        <!-- Alpine Ïª¥Ìè¨ÎÑåÌä∏ ÎÅù -->
        
        <!-- Í≥µÌÜµ Î∞±Í∑∏ÎùºÏö¥Îìú Ïò§Î≤ÑÎ†àÏù¥ -->
        <div
            x-show="active"
            x-cloak
            class="fixed inset-0 bg-black bg-opacity-50 z-40"
            @click="close()"
        ></div>

        <!-- Í≥µÌÜµ Î°úÎî©ÌôîÎ©¥ -->
        <div x-show="loading" class="fixed inset-0 flex items-center justify-center bg-white bg-opacity-70 z-60">
        <svg class="animate-spin h-12 w-12 text-orange-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" sroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z">
        </path>
        </svg>
        </div>
        </div>

    </div>
    
    <div class="@container">
    <div class="overflow-x-auto rounded-lg border border-[var(--border-color)]">
    <table class="min-w-full divide-y divide-[var(--border-color)]">
    <thead class="bg-slate-50">
    <tr>
    <th class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-120 px-6 py-4 text-left text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider" scope="col">
                            ÏÇ¨Ïö©ÏûêÎ™Ö
                            </th>
    <th class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-240 px-6 py-4 text-left text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider" scope="col">
                            Ïù¥Î©îÏùº
                            </th>
    <th class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-480 px-6 py-4 text-left text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider" scope="col">
                            Ïó≠Ìï†
                            </th>
    <th class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-480 px-6 py-4 text-left text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider" scope="col">
                            Î∂ÄÏÑú
                            </th>
    <th class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-480 px-6 py-4 text-left text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider" scope="col">
                            ÏÉùÏÑ± ÎÇ†Ïßú
                            </th>
    </tr>
    </thead>
    <tbody class="divide-y divide-[var(--border-color)] bg-white">
    {% for user in users %}
        <tr>
        <td class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-120 whitespace-nowrap px-6 py-4 text-sm font-medium text-[var(--text-primary)]">{{user.name}}</td>
        <td class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-360 whitespace-nowrap px-6 py-4 text-sm text-[var(--text-secondary)]">{{user.email}}</td>
        <td class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-480 whitespace-nowrap px-6 py-4 text-sm text-[var(--text-secondary)]">{{user.role}}</td>
        <td class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-480 whitespace-nowrap px-6 py-4 text-sm text-[var(--text-secondary)]">{{user.org}}</td>
        <td class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-480 whitespace-nowrap px-6 py-4 text-sm text-[var(--text-secondary)]">{{user.created_at}}</td>
    </tr>
    {% endfor %}
    </tbody>
    </table>
    </div>
    <!-- ÌéòÏù¥ÏßïÏ≤òÎ¶¨ ÏãúÏûë -->
    <nav aria-label="Pagination" class="py-6">
    <ul class="flex items-center justify-center space-x-2">
        <!-- Ïù¥Ï†Ñ ÌéòÏù¥ÏßÄ -->
        {% if users.has_previous %}
        <li>
            <a href="?page={{ users.previous_page_number }}"
                class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-100">
                Ïù¥Ï†Ñ
            </a>
        </li>
        {% else %}
        <li>
            <span
                class="px-3 py-1 border border-gray-200 rounded-md text-gray-400 bg-gray-100 cursor-not-allowed">
                Ïù¥Ï†Ñ
            </span>
        </li>
        {% endif %}

        <!-- ÌéòÏù¥ÏßÄ Î≤àÌò∏ -->
        {% for page_number in users.paginator.page_range %}
        {% if page_number >= users.number|add:-5 and page_number <= users.number|add:5 %}
        {% if page_number == users.number %}
        <li>
            <span class="px-3 py-1 bg-blue-600 text-white border border-blue-600 rounded-md">
            {{ page_number }}
            </span>
        </li>
        {% else %}
        <li>
            <a href="?page={{ page_number }}"
            class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-100">
            {{ page_number }}
            </a>
        </li>
        {% endif %}
        {% endif %}
        {% endfor %}

        <!-- Îã§Ïùå ÌéòÏù¥ÏßÄ -->
        {% if users.has_next %}
        <li>
            <a href="?page={{ users.next_page_number }}"
                class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-100">
                Îã§Ïùå
            </a>
        </li>
        {% else %}
        <li>
            <span
                class="px-3 py-1 border border-gray-200 rounded-md text-gray-400 bg-gray-100 cursor-not-allowed">
                Îã§Ïùå
            </span>
        </li>
        {% endif %}
    </ul>
    </nav>
    <!-- ÌéòÏù¥ÏßïÏ≤òÎ¶¨ ÎÅù -->
    <style>
                        @container(max-width:120px) {
                        .table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-120 {
                            display: none;
                        }
                        }
                        @container(max-width:240px) {
                        .table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-240 {
                            display: none;
                        }
                        }
                        @container(max-width:360px) {
                        .table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-360 {
                            display: none;
                        }
                        }
                        @container(max-width:480px) {
                        .table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-480 {
                            display: none;
                        }
                        }
                    </style>
    </div>
    </section>
    <!-- ÏÑ±Í≥µ Î©îÏãúÏßÄ Ï∂úÎ†• ÎòêÎäî ÏóêÎü¨ Î©îÏãúÏßÄ Ï∂úÎ†•-->
    {% if messages %}
        {% for message in messages %}
            <script>alert("{{ message|escapejs }}");</script>
        {% endfor %}
    {% endif %}
    </div>
    </div>
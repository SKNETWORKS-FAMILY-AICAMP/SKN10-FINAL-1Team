<div class="p-8">
    <div class="mx-auto max-w-4xl">
    <!-- alpine.js ì„í¬íŠ¸-->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
    <!-- alpine.js ì„í¬íŠ¸--> 
    <section x-data="{
        // í˜„ì¬ ì—´ë ¤ ìˆëŠ” ëª¨ë‹¬ êµ¬ë¶„: 'add' | 'delete' | 'multi' | null
        active: null,
        // ê³µí†µ ìƒíƒœ
        loading: false, error: '',
        // ëª¨ë‹¬ë³„ í¼ ë°ì´í„°
        add:    { email:'', pw:'', pw_confirm:'', username:'' },
        del:    { email:'' },
        // ëª¨ë‹¬ ì—´ê³  ë‹«ê¸°
        open(name) { this.active = name},
        close() { 
            this.active = null
            this.error = ''
        },
        submitDelete(event) {
            if (!this.del.email) {
                this.error = 'ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'
            }
            else {
                // í™•ì¸ì°½ ë„ìš°ê¸°
                if (confirm('âš ï¸ ì •ë§ ì´ ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    this.loading = true
                    this.$nextTick(() => event.target.submit())
                }   
            }
        },
        submitAdd(event) {
            if (!this.add.email) {
                this.error = 'ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'
            } else if (!this.add.pw) {
                this.error = 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!'
            } else if (!this.add.pw_confirm) {
                this.error = 'ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'
            } else if (this.add.pw !== this.add.pw_confirm) {
                this.error = 'ë‘ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•Šì•„ìš”!'
            } else if (!this.add.username) {
                this.error = 'ì‚¬ìš©ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'
            } else {
                // í™•ì¸ì°½ ë„ìš°ê¸°
                if (confirm('âš ï¸ ì •ë§ ì´ ê³„ì •ì„ ì¶”ê°€í• ê¹Œìš”?')) {
                    this.loading = true
                    this.$nextTick(() => event.target.submit())
                }   
            }
        },
        submitMultiAdd(event) {
            // 1) íŒŒì¼ ì²´í¬
            if (!$refs.fileInput.files.length) {
                this.error = 'ì˜¤ë¥˜ : íŒŒì¼ì„ ì„ íƒí•´ì¤˜!'
                return
            }
            // 1-1) CSV í™•ì¥ì ì²´í¬
            const file = $refs.fileInput.files[0];
            const name = file.name.toLowerCase();
            if (!name.endsWith('.csv')) {
                this.error = 'ì˜¤ë¥˜ : CSV íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆì–´!';
                return;
            }
            // 3) í™•ì¸ì°½
            if (!confirm(`âš ï¸ ì •ë§ ë‹¤ì¤‘ ê³„ì •ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return
            }
            // 4) ëª¨ë‘ í†µê³¼í•˜ë©´ ë¡œë”© ì¼œê³  í¼ ì œì¶œ
            this.loading = true
            $refs.multiForm.submit()
        },
    }"
    class="rounded-lg bg-white p-6 shadow-md border border-gray-200">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-[var(--text-primary)] text-2xl font-semibold leading-tight tracking-[-0.015em]">ì‚¬ìš©ì ëª©ë¡</h3>
        <div class="flex items-center gap-4 ml-auto">
        
        <!-- ê³„ì • ì‚­ì œ Alpine ì»´í¬ë„ŒíŠ¸ ì‹œì‘ -->
        <div class="relative">

        <!-- 1) ê³„ì • ì‚­ì œ ë²„íŠ¼ -->
        <button
            @click="open('delete')"
            class="flex items-center gap-3 rounded-full px-6 py-1.5 bg-orange-400 hover:bg-orange-600 text-black"
        ><span class="material-icons-outlined font-bold">ê³„ì • ì‚­ì œ</span></button>

        <!-- 2) ê³„ì • ì‚­ì œ ëª¨ë‹¬ ë°•ìŠ¤ -->
        <div
            x-show="active === 'delete'"
            class="fixed inset-0 flex items-center justify-center z-50 p-4"
            x-cloak
        >
            <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
            <div class="flex justify-between items-center px-6 py-4 border-b">
                <h2 class="text-lg font-semibold">ê³„ì • ì‚­ì œ</h2>
                <button @click="close()" class="text-xl leading-none">&times;</button>
            </div>

            <form
                action="{% url 'knowledge:delete_user' %}"
                method="post"
                class="px-6 py-4 space-y-4"
                @submit.prevent="submitDelete($event)">
                {% csrf_token %}

                <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
                <div x-show="error"
                class="flex items-start space-x-2 bg-red-50 border-l-4 border-red-600 text-red-700 p-3 rounded-md shadow-sm mt-2">
                <!-- ì‹¤ì œ ë©”ì‹œì§€ -->
                <span x-text="error" class="text-sm"></span>
                </div>
                
                <div>
                <label class="block text-sm font-medium">ğŸ†”<span class="text-red-500"> ì‚­ì œí•  ì´ë©”ì¼</span>ì„ ì…ë ¥í•˜ì„¸ìš”! </label>
                <input type="email" name="email" x-model="del.email" class="mt-1 w-full border rounded px-3 py-2" />
                </div>
    
                <div class="text-right space-x-2">
                <button type="button" @click="close()" class="px-4 py-2 rounded border hover:bg-gray-100">ì·¨ì†Œ</button>
                <button type="submit" class="px-4 py-2 rounded bg-red-500 hover:bg-red-700 text-white">ì‚­ì œ</button>
                </div>
            </form>
            </div>
        </div>
        </div>
        <!-- ê³„ì • ì‚­ì œ Alpine ì»´í¬ë„ŒíŠ¸ ë -->

        
        <!-- ê³„ì • ì¶”ê°€ Alpine ì»´í¬ë„ŒíŠ¸ ì‹œì‘ -->
        <div class="relative">
        <!-- 1) ê³„ì • ì¶”ê°€ ë²„íŠ¼ -->

        <button
            @click="open('add')"
            class="flex items-center gap-3 rounded-full px-6 py-1.5 bg-orange-400 hover:bg-orange-600 text-black"
        ><span class="material-icons-outlined font-bold">ê³„ì • ì¶”ê°€</span></button>

        <!-- 2) ê³„ì • ì¶”ê°€ ëª¨ë‹¬ ë°•ìŠ¤ -->
        <div x-show="active === 'add'" class="fixed inset-0 flex items-center justify-center z-50 p-4" x-cloak>
            <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
            <div class="flex justify-between items-center px-6 py-4 border-b">
                <h2 class="text-lg font-semibold">ê³„ì • ì¶”ê°€</h2>
                <button @click="close()" class="text-xl leading-none">&times;</button>
            </div>


            <form
                action="{% url 'knowledge:create_user' %}"
                method="post"
                class="px-6 py-4 space-y-4"
                @submit.prevent="submitAdd($event)">
                {% csrf_token %}
                
                <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
                <div
                x-show="error"
                class="flex items-start space-x-2 bg-red-50 border-l-4 border-red-600 text-red-700 p-3 rounded-md shadow-sm mt-2"
                >
                <!-- ì‹¤ì œ ë©”ì‹œì§€ -->
                <span x-text="error" class="text-sm"></span>
                </div>

                <div>
                <label class="block text-sm font-medium">ì´ë©”ì¼</label>
                <input type="email" name="email"
                x-model="add.email"
                @input="error = ''"
                class="mt-1 w-full border rounded px-3 py-2" />
                </div>

                <div>
                <label class="block text-sm font-medium">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" name="pw"
                x-model="add.pw"
                @input="error = ''"
                class="mt-1 w-full border rounded px-3 py-2" />
                </div>

                <div>
                <label class="block text-sm font-medium">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" name="pw_confirm"
                x-model="add.pw_confirm"
                @input="error = ''"
                class="mt-1 w-full border rounded px-3 py-2" />
                </div>

                <div>
                <label class="block text-sm font-medium">ì‚¬ìš©ìëª…</label>
                <input name="username"
                x-model="add.username"
                @input="error = ''"
                class="mt-1 w-full border rounded px-3 py-2" />
                </div>

                <div>
                <label class="block text-sm font-medium">ê¶Œí•œ</label>
                <select id="authority" name="authority" class="w-full border rounded p-2">
                    <option value="admin">admin</option>
                    <option value="employee">employee</option>
                    <option value="guest">guest</option>
                </select>
                </div>

                <div>
                <label class="block text-sm font-medium">ë¶€ì„œ</label>
                <select id="department" name="department" class="w-full border rounded p-2">
                    <option value="development">development</option>
                    <option value="business_strategy">business_strategy</option>
                    <option value="customer_management">customer_management</option>
                    <option value="administrator">administrator</option>
                </select>
                </div>


                <div class="text-right space-x-2">
                <button type="button" @click="close()" class="px-4 py-2 rounded border hover:bg-gray-100">ì·¨ì†Œ</button>
                <button type="submit" class="px-4 py-2 rounded bg-orange-400 hover:bg-orange-600 text-white">ì¶”ê°€</button>
                </div>
            </form>
            </div>
        </div>
        </div>
        <!-- Alpine ì»´í¬ë„ŒíŠ¸ ë -->

        <!-- ë‹¤ì¤‘ ê³„ì • ì¶”ê°€ Alpine ì»´í¬ë„ŒíŠ¸ ì‹œì‘ -->
        <div class="relative">

        <!-- 1) ë‹¤ì¤‘ ê³„ì • ìƒì„± ë²„íŠ¼ -->
        <button 
        @click="open('multi')"
        class="flex items-center gap-3 rounded-full px-6 py-1.5 bg-orange-400 hover:bg-orange-600 text-black"
        ><span class="material-icons-outlined font-bold">ë‹¤ì¤‘ ê³„ì • ì¶”ê°€</span></button>

        <!-- 2) ë‹¤ì¤‘ ê³„ì • ëª¨ë‹¬ ë°•ìŠ¤ -->
        <div x-show="active === 'multi'" class="fixed inset-0 flex items-center justify-center z-50 p-4" x-cloak>
            <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
            <div class="flex justify-between items-center px-6 py-4 border-b">
                <h2 class="text-lg font-semibold">ë‹¤ì¤‘ ê³„ì • ì¶”ê°€</h2>
                <button @click="close()" class="text-xl leading-none">&times;</button>
            </div>
            
            <!-- ì£¼ì˜ì‚¬í•­ -->
            <p class="flex text-sm items-start space-x-2 bg-red-50 text-red-700 p-3 rounded-md shadow-sm m-4 ">
                â€»ì£¼ì˜ì‚¬í•­ :<br>
                1. ì…ë ¥ íŒŒì¼ì€ csvíŒŒì¼ì´ì–´ì•¼ í•¨. <br>
                2. name, id, authority, department ì»¬ëŸ¼ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ì•¼ í•¨.<br>
                3. ì»¬ëŸ¼ê°’ì€ nullê°’ì´ ì—†ì–´ì•¼ í•¨.  
            </p>

            <form
                action="{% url 'knowledge:create_multi_user' %}"
                method="post"
                class="px-6 space-y-4"
                enctype="multipart/form-data"
                x-ref="multiForm"
                @submit.prevent="submitMultiAdd()">
                {% csrf_token %}

                <div>
                <label class="block text-sm font-medium">ğŸ“‚ ì¶”ê°€í•  ì§ì›ë“¤ì˜ ì •ë³´ê°€ ë‹´ê¸´ csvíŒŒì¼ì„ ë„£ì–´ì£¼ì„¸ìš”! </label>
                <input type="file" name="file" x-ref="fileInput" class="mt-2 w-full border rounded px-3 py-2" />
                </div>
    
                <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
                <p x-show="error" x-text="error" class="text-red-600 text-sm mt-2"></p>

                <div class="text-right space-x-2">
                <button type="button" @click="close()" class="px-4 py-2 rounded border hover:bg-gray-100">ì·¨ì†Œ</button>
                <button type="submit" class="px-4 py-2 rounded bg-red-500 hover:bg-red-700 text-white">ìƒì„±</button>
                </div>
                
            </form>
            </div>
        </div>
        </div>
        <!-- Alpine ì»´í¬ë„ŒíŠ¸ ë -->
        
        <!-- ê³µí†µ ë°±ê·¸ë¼ìš´ë“œ ì˜¤ë²„ë ˆì´ -->
        <div
            x-show="active"
            x-cloak
            class="fixed inset-0 bg-black bg-opacity-50 z-40"
            @click="close()"
        ></div>

        <!-- ê³µí†µ ë¡œë”©í™”ë©´ -->
        <div x-show="loading" class="fixed inset-0 flex items-center justify-center bg-white bg-opacity-70 z-60">
        <svg class="animate-spin h-12 w-12 text-orange-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" sroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z">
        </path>
        </svg>
        </div>
        </div>

    </div>
    
    <div class="@container">
    <div class="overflow-x-auto rounded-lg border border-[var(--border-color)]">
    <table class="min-w-full divide-y divide-[var(--border-color)]">
    <thead class="bg-slate-50">
    <tr>
    <th class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-120 px-6 py-4 text-left text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider" scope="col">
                            ì‚¬ìš©ìëª…
                            </th>
    <th class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-240 px-6 py-4 text-left text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider" scope="col">
                            ì´ë©”ì¼
                            </th>
    <th class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-480 px-6 py-4 text-left text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider" scope="col">
                            ì—­í• 
                            </th>
    <th class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-480 px-6 py-4 text-left text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider" scope="col">
                            ë¶€ì„œ
                            </th>
    <th class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-480 px-6 py-4 text-left text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider" scope="col">
                            ìƒì„± ë‚ ì§œ
                            </th>
    </tr>
    </thead>
    <tbody class="divide-y divide-[var(--border-color)] bg-white">
    {% for user in users %}
        <tr>
        <td class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-120 whitespace-nowrap px-6 py-4 text-sm font-medium text-[var(--text-primary)]">{{user.name}}</td>
        <td class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-360 whitespace-nowrap px-6 py-4 text-sm text-[var(--text-secondary)]">{{user.email}}</td>
        <td class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-480 whitespace-nowrap px-6 py-4 text-sm text-[var(--text-secondary)]">{{user.role}}</td>
        <td class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-480 whitespace-nowrap px-6 py-4 text-sm text-[var(--text-secondary)]">{{user.org}}</td>
        <td class="table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-480 whitespace-nowrap px-6 py-4 text-sm text-[var(--text-secondary)]">{{user.created_at}}</td>
    </tr>
    {% endfor %}
    </tbody>
    </table>
    </div>
    <!-- í˜ì´ì§•ì²˜ë¦¬ ì‹œì‘ -->
    <nav aria-label="Pagination" class="py-6">
    <ul class="flex items-center justify-center space-x-2">
        <!-- ì´ì „ í˜ì´ì§€ -->
        {% if users.has_previous %}
        <li>
            <a href="?page={{ users.previous_page_number }}"
                class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-100">
                ì´ì „
            </a>
        </li>
        {% else %}
        <li>
            <span
                class="px-3 py-1 border border-gray-200 rounded-md text-gray-400 bg-gray-100 cursor-not-allowed">
                ì´ì „
            </span>
        </li>
        {% endif %}

        <!-- í˜ì´ì§€ ë²ˆí˜¸ -->
        {% for page_number in users.paginator.page_range %}
        {% if page_number >= users.number|add:-5 and page_number <= users.number|add:5 %}
        {% if page_number == users.number %}
        <li>
            <span class="px-3 py-1 bg-blue-600 text-white border border-blue-600 rounded-md">
            {{ page_number }}
            </span>
        </li>
        {% else %}
        <li>
            <a href="?page={{ page_number }}"
            class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-100">
            {{ page_number }}
            </a>
        </li>
        {% endif %}
        {% endif %}
        {% endfor %}

        <!-- ë‹¤ìŒ í˜ì´ì§€ -->
        {% if users.has_next %}
        <li>
            <a href="?page={{ users.next_page_number }}"
                class="px-3 py-1 border border-gray-300 rounded-md hover:bg-gray-100">
                ë‹¤ìŒ
            </a>
        </li>
        {% else %}
        <li>
            <span
                class="px-3 py-1 border border-gray-200 rounded-md text-gray-400 bg-gray-100 cursor-not-allowed">
                ë‹¤ìŒ
            </span>
        </li>
        {% endif %}
    </ul>
    </nav>
    <!-- í˜ì´ì§•ì²˜ë¦¬ ë -->
    <style>
                        @container(max-width:120px) {
                        .table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-120 {
                            display: none;
                        }
                        }
                        @container(max-width:240px) {
                        .table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-240 {
                            display: none;
                        }
                        }
                        @container(max-width:360px) {
                        .table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-360 {
                            display: none;
                        }
                        }
                        @container(max-width:480px) {
                        .table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-480 {
                            display: none;
                        }
                        }
                    </style>
    </div>
    </section>
    <!-- ì„±ê³µ ë©”ì‹œì§€ ì¶œë ¥ ë˜ëŠ” ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥-->
    {% if messages %}
        {% for message in messages %}
            <script>alert("{{ message|escapejs }}");</script>
        {% endfor %}
    {% endif %}
    </div>
    </div>
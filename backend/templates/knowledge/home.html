<div class="p-8">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
    <div class="mx-auto max-w-5xl">
    <!-- 여기서 가로 레이아웃을 지정: 모바일에선 한 줄, 데스크탑(md 이상)에선 2열 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <section class="rounded-lg bg-white p-6 shadow-md border border-gray-200">
    <h3 class="text-[var(--text-primary)] text-xl font-semibold leading-tight tracking-[-0.015em] mb-6">최근 채팅 목록</h3>
    <div class="@container">
    <div class="overflow-x-auto rounded-lg border border-[var(--border-color)]">
    <table class="min-w-full divide-y divide-[var(--border-color)]">
    <thead class="bg-slate-50">
    <tr>
    <th class="px-4 py-2 text-left text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider" scope="col">
                            번호
                            </th>
    <th class="px-4 py-2 text-left text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider" scope="col">
                            제목
                            </th>
    <th class="px-4 py-2 text-left text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider" scope="col">
                            메시지 수
                            </th>
    <th class="px-4 py-2 text-left text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider" scope="col">
                            생성 일자
                            </th>
    </tr>
    </thead>
    <tbody class="divide-y divide-[var(--border-color)] bg-white">
    {% if recent_sessions %}
    {% for session in recent_sessions %}
        <tr>
        <td class=" whitespace-nowrap px-4 py-2 text-left text-xs font-medium text-[var(--text-primary)]">{{ forloop.counter }}</td>
        <td class=" whitespace-nowrap px-4 py-2 text-left text-xs font-medium text-[var(--text-primary)]"
            x-data="{ open: false, messages : [], loaded: false }">
            <!-- 텍스트 컴포넌트-->
            <div @click="open = true">
                <a href="{% url 'knowledge:session_detail' session.id %}"
                @click.prevent="
                    open = true;
                    if (!loaded) {
                        fetch('{% url 'knowledge:session_detail' session.id %}')
                        .then(res => res.json())
                        .then(data => {
                        messages = data.messages;
                        loaded = true;
                    });
                    }"
                class="text-blue-500 hover:text-blue-700 underline">{{session.title|truncatechars:6}}</a>
            </div>

            <!-- 백그라운드 오버레이 -->
            <div
                x-show="open"
                x-cloak
                class="fixed inset-0 bg-black bg-opacity-50 z-40"
                @click="open = false"
            ></div>

            <!-- 모달 -->
            <div
            x-show="open"
            class="fixed inset-0 flex items-center justify-center z-50 p-4"
            x-cloak>

            <div class="bg-white rounded-lg shadow-lg
                w-full             
                max-w-4xl          
                max-h-[90vh]      
                overflow-y-auto    
                overflow-x-hidden  
                whitespace-normal  
                break-words        
                p-4                
                ">
            <div class="flex justify-between items-center px-4 py-4 border-b">
                <h2 class="text-2xl font-semibold">Session 상세화면</h2>
                <button @click="open = false" class="text-xl leading-none">&times;</button>
            </div>
            <div class="space-y-2">
                <template x-if="!loaded">
                    <p class="text-center text-gray-500">로딩 중…</p>
                </template>
                
                <!-- 컴팩트한 요약 카드 -->
                <div x-show="loaded" class="bg-white rounded-lg shadow p-3 mb-6">
                <!-- 헤더: 제목 + 날짜 -->
                <div class="flex items-center justify-between pb-2">
                    <h3 class="text-lg font-semibold text-gray-800">
                    "{{ session.title }}"
                    </h3>
                    <span class="text-sm text-gray-500">
                    {{ session.started_at|date:"F j, Y, g:i" }}
                    </span>
                </div>

                <!-- 메타 정보: flex-wrap + gap으로 촘촘하게 -->
                <!-- 메타 정보: 세로 배치 -->
                <div class="mt-2 flex flex-col space-y-1 text-sm text-gray-700">
                <div>
                    <span class="font-semibold">유저:</span>
                    <span>{{ session.user }}</span>
                </div>
                <div>
                    <span class="font-semibold">Agent:</span>
                    <span>{{ session.agent_type }}</span>
                </div>
                <div>
                    <span class="font-semibold">삭제 여부:</span>
                    <span class="{% if session.deleted_check %}text-red-600{% else %}text-green-600{% endif %}">
                    {% if session.deleted_check %}O{% else %}X{% endif %}
                    </span>
                </div>
                <div>
                    <span class="font-semibold">메시지 수:</span>
                    <span x-text="messages.length"></span>
                </div>
                </div>
                </div>



                <!-- 메시지 리스트 -->
                <template x-for="msg in messages" :key="msg.id">
                    <!-- 1) flex 컨테이너로 좌/우 정렬 -->
                    <div class="flex"
                    :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">

                    <!-- 2) 말풍선 박스 -->
                    <div class="max-w-[70%] p-3 rounded-lg"
                    :class="msg.role === 'user'
                    ? 'bg-blue-500 text-white rounded-br-none'
                    : 'bg-gray-100 text-black rounded-bl-none'"
                    >

                    <!-- 3) 내용 -->
                    <p class="whitespace-normal break-words" x-text="msg.content"></p>

                    <!-- 4) 타임스탬프 (버블 안쪽 오른쪽 하단) -->
                    <p class="text-[10px] opacity-75 text-right mt-1" x-text="msg.created_at"></p>

                    </div>
                    </div>
                </template>

                <!-- 메시지 없을 때 -->
                <template x-if="loaded && messages.length === 0">
                    <p class="text-center text-gray-500">메시지가 없습니다.</p>
                </template>
                
                </div>
            </div>
            </div>
            </div>
        </td>
        <td class=" whitespace-nowrap px-4 py-2 text-left text-xs text-[var(--text-secondary)]">{{session.messages.count }}</td>
        <td class=" whitespace-nowrap px-4 py-2 text-left text-xs text-[var(--text-secondary)]">{{session.started_at|date:"F j, Y, g:i A"}}</td>
    </tr>
    {% endfor %}
    {% else %}
        <p>최근 세션이 존재하지 않습니다!</p>
    {% endif %}
    </tbody>
    </table>
    </div>
    <style>
                        @container(max-width:120px) {
                        .table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-120 {
                            display: none;
                        }
                        }
                        @container(max-width:240px) {
                        .table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-240 {
                            display: none;
                        }
                        }
                        @container(max-width:360px) {
                        .table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-360 {
                            display: none;
                        }
                        }
                        @container(max-width:480px) {
                        .table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-480 {
                            display: none;
                        }
                        }
                    </style>
    </section>

    <section class="rounded-lg bg-white p-6 shadow-md border border-gray-200">
    <h3 class="text-xl font-semibold mb-4">최근 채팅 추이</h3>
    <!-- Chart 영역에 고정 높이 주기 -->
    <div class="h-48 w-full">
        <canvas id="session-count-chart"></canvas>
    </div>
    </section>

    <!-- body 맨 아래에 Chart.js 불러오기 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 2. date-fns core (v2 이상) -->
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/dist/date-fns.min.js"></script>
    <!-- 3. date-fns 어댑터 -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2"></script>
    <script>
    // API 호출 + 에러 로그
    fetch("{% url 'knowledge:session_counts_api' %}")
        .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
        })
        .then(data => {
        console.log('session_counts data:', data);
        const labels = data.map(d => d.day);
        const counts = data.map(d => d.count);

        const canvas = document.getElementById('session-count-chart');
        if (!canvas) return console.error('⚠️ canvas element 못찾음');
        const ctx = canvas.getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
            labels,
            datasets: [{
                label: '세션 수',
                data: counts,
                backgroundColor: 'rgba(59,130,246,0.5)',
                borderColor: 'rgba(59,130,246,1)',
                borderWidth: 1
            }]
            },
            options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                beginAtZero: true,
                ticks: { stepSize: 1 }
                }
            }
            }
        });
        })
        .catch(err => console.error('🔴 차트 렌더링 에러:', err));
    </script>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
        <section class="rounded-lg bg-white p-6 shadow-md border border-gray-200">
        <h3 class="text-xl font-semibold mb-4">가입자 수 추이</h3>
        <div class="h-48 w-full">
            <canvas id="user-count-chart"></canvas>
        </div>
        </section>

        <script>
        document.addEventListener('DOMContentLoaded', () => {
        // 가입자 수 API 호출
        fetch("{% url 'knowledge:user_counts_api' %}")
            .then(res => {
            if (!res.ok) throw new Error('HTTP ' + res.status);
            return res.json();
            })
            .then(data => {
            const labels = data.map(d => d.day);
            const counts = data.map(d => d.count);

            const ctx = document
                .getElementById('user-count-chart')
                .getContext('2d');

            new Chart(ctx, {
                type: 'line',           // line 차트
                data: {
                labels,
                datasets: [{
                    label: '가입자 수',
                    data: counts,
                    fill: false,                 // 선 아래 채우기 없음
                    borderColor: 'rgba(234, 88, 12, 1)', // Tailwind red-500
                    borderWidth: 2,
                    pointRadius: 3,
                    pointBackgroundColor: 'rgba(234, 88, 12, 1)'
                }]
                },
                options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                    }
                }
                }
            });
            })
            .catch(err => console.error('가입자 차트 에러:', err));
        });
        </script>

        <section class="rounded-lg bg-white p-6 shadow-md border border-gray-200">
            <h3 class="text-xl font-semibold mb-4">CPU/메모리 사용량</h3>
            <div class="h-48 w-full">
                <canvas id="ec2Chart" width="800" height="400"></canvas>                
            </div>
        </section>

        
    </div>

    </div>    
    </div>
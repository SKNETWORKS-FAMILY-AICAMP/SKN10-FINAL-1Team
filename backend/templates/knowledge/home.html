<div class="p-8">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
    <div class="mx-auto max-w-5xl">
    <!-- ì—¬ê¸°ì„œ ê°€ë¡œ ë ˆì´ì•„ì›ƒì„ ì§€ì •: ëª¨ë°”ì¼ì—ì„  í•œ ì¤„, ë°ìŠ¤í¬íƒ‘(md ì´ìƒ)ì—ì„  2ì—´ -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <section class="rounded-lg bg-white p-6 shadow-md border border-gray-200">
    <h3 class="text-[var(--text-primary)] text-xl font-semibold leading-tight tracking-[-0.015em] mb-6">ìµœê·¼ ì±„íŒ… ëª©ë¡</h3>
    <div class="@container">
    <div class="overflow-x-auto rounded-lg border border-[var(--border-color)]">
    <table class="min-w-full divide-y divide-[var(--border-color)]">
    <thead class="bg-slate-50">
    <tr>
    <th class="px-4 py-2 text-left text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider" scope="col">
                            ë²ˆí˜¸
                            </th>
    <th class="px-4 py-2 text-left text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider" scope="col">
                            ì œëª©
                            </th>
    <th class="px-4 py-2 text-left text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider" scope="col">
                            ë©”ì‹œì§€ ìˆ˜
                            </th>
    <th class="px-4 py-2 text-left text-xs font-semibold text-[var(--text-secondary)] uppercase tracking-wider" scope="col">
                            ìƒì„± ì¼ì
                            </th>
    </tr>
    </thead>
    <tbody class="divide-y divide-[var(--border-color)] bg-white">
    {% if recent_sessions %}
    {% for session in recent_sessions %}
        <tr>
        <td class=" whitespace-nowrap px-4 py-2 text-left text-xs font-medium text-[var(--text-primary)]">{{ forloop.counter }}</td>
        <td class=" whitespace-nowrap px-4 py-2 text-left text-xs font-medium text-[var(--text-primary)]"
            x-data="{ open: false, messages : [], loaded: false }">
            <!-- í…ìŠ¤íŠ¸ ì»´í¬ë„ŒíŠ¸-->
            <div @click="open = true">
                <a href="{% url 'knowledge:session_detail' session.id %}"
                @click.prevent="
                    open = true;
                    if (!loaded) {
                        fetch('{% url 'knowledge:session_detail' session.id %}')
                        .then(res => res.json())
                        .then(data => {
                        messages = data.messages;
                        loaded = true;
                    });
                    }"
                class="text-blue-500 hover:text-blue-700 underline">{{session.title|truncatechars:6}}</a>
            </div>

            <!-- ë°±ê·¸ë¼ìš´ë“œ ì˜¤ë²„ë ˆì´ -->
            <div
                x-show="open"
                x-cloak
                class="fixed inset-0 bg-black bg-opacity-50 z-40"
                @click="open = false"
            ></div>

            <!-- ëª¨ë‹¬ -->
            <div
            x-show="open"
            class="fixed inset-0 flex items-center justify-center z-50 p-4"
            x-cloak>

            <div class="bg-white rounded-lg shadow-lg
                w-full             
                max-w-4xl          
                max-h-[90vh]      
                overflow-y-auto    
                overflow-x-hidden  
                whitespace-normal  
                break-words        
                p-4                
                ">
            <div class="flex justify-between items-center px-4 py-4 border-b">
                <h2 class="text-2xl font-semibold">Session ìƒì„¸í™”ë©´</h2>
                <button @click="open = false" class="text-xl leading-none">&times;</button>
            </div>
            <div class="space-y-2">
                <template x-if="!loaded">
                    <p class="text-center text-gray-500">ë¡œë”© ì¤‘â€¦</p>
                </template>
                
                <!-- ì»´íŒ©íŠ¸í•œ ìš”ì•½ ì¹´ë“œ -->
                <div x-show="loaded" class="bg-white rounded-lg shadow p-3 mb-6">
                <!-- í—¤ë”: ì œëª© + ë‚ ì§œ -->
                <div class="flex items-center justify-between pb-2">
                    <h3 class="text-lg font-semibold text-gray-800">
                    "{{ session.title }}"
                    </h3>
                    <span class="text-sm text-gray-500">
                    {{ session.started_at|date:"F j, Y, g:i" }}
                    </span>
                </div>

                <!-- ë©”íƒ€ ì •ë³´: flex-wrap + gapìœ¼ë¡œ ì´˜ì´˜í•˜ê²Œ -->
                <!-- ë©”íƒ€ ì •ë³´: ì„¸ë¡œ ë°°ì¹˜ -->
                <div class="mt-2 flex flex-col space-y-1 text-sm text-gray-700">
                <div>
                    <span class="font-semibold">ìœ ì €:</span>
                    <span>{{ session.user }}</span>
                </div>
                <div>
                    <span class="font-semibold">Agent:</span>
                    <span>{{ session.agent_type }}</span>
                </div>
                <div>
                    <span class="font-semibold">ì‚­ì œ ì—¬ë¶€:</span>
                    <span class="{% if session.deleted_check %}text-red-600{% else %}text-green-600{% endif %}">
                    {% if session.deleted_check %}O{% else %}X{% endif %}
                    </span>
                </div>
                <div>
                    <span class="font-semibold">ë©”ì‹œì§€ ìˆ˜:</span>
                    <span x-text="messages.length"></span>
                </div>
                </div>
                </div>



                <!-- ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ -->
                <template x-for="msg in messages" :key="msg.id">
                    <!-- 1) flex ì»¨í…Œì´ë„ˆë¡œ ì¢Œ/ìš° ì •ë ¬ -->
                    <div class="flex"
                    :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">

                    <!-- 2) ë§í’ì„  ë°•ìŠ¤ -->
                    <div class="max-w-[70%] p-3 rounded-lg"
                    :class="msg.role === 'user'
                    ? 'bg-blue-500 text-white rounded-br-none'
                    : 'bg-gray-100 text-black rounded-bl-none'"
                    >

                    <!-- 3) ë‚´ìš© -->
                    <p class="whitespace-normal break-words" x-text="msg.content"></p>

                    <!-- 4) íƒ€ì„ìŠ¤íƒ¬í”„ (ë²„ë¸” ì•ˆìª½ ì˜¤ë¥¸ìª½ í•˜ë‹¨) -->
                    <p class="text-[10px] opacity-75 text-right mt-1" x-text="msg.created_at"></p>

                    </div>
                    </div>
                </template>

                <!-- ë©”ì‹œì§€ ì—†ì„ ë•Œ -->
                <template x-if="loaded && messages.length === 0">
                    <p class="text-center text-gray-500">ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </template>
                
                </div>
            </div>
            </div>
            </div>
        </td>
        <td class=" whitespace-nowrap px-4 py-2 text-left text-xs text-[var(--text-secondary)]">{{session.messages.count }}</td>
        <td class=" whitespace-nowrap px-4 py-2 text-left text-xs text-[var(--text-secondary)]">{{session.started_at|date:"F j, Y, g:i A"}}</td>
    </tr>
    {% endfor %}
    {% else %}
        <p>ìµœê·¼ ì„¸ì…˜ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!</p>
    {% endif %}
    </tbody>
    </table>
    </div>
    <style>
                        @container(max-width:120px) {
                        .table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-120 {
                            display: none;
                        }
                        }
                        @container(max-width:240px) {
                        .table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-240 {
                            display: none;
                        }
                        }
                        @container(max-width:360px) {
                        .table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-360 {
                            display: none;
                        }
                        }
                        @container(max-width:480px) {
                        .table-1fe95620-04dc-4fb3-af13-df40c44c1ea2-column-480 {
                            display: none;
                        }
                        }
                    </style>
    </section>

    <section class="rounded-lg bg-white p-6 shadow-md border border-gray-200">
    <h3 class="text-xl font-semibold mb-4">ìµœê·¼ ì±„íŒ… ì¶”ì´</h3>
    <!-- Chart ì˜ì—­ì— ê³ ì • ë†’ì´ ì£¼ê¸° -->
    <div class="h-48 w-full">
        <canvas id="session-count-chart"></canvas>
    </div>
    </section>

    <!-- body ë§¨ ì•„ë˜ì— Chart.js ë¶ˆëŸ¬ì˜¤ê¸° -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 2. date-fns core (v2 ì´ìƒ) -->
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/dist/date-fns.min.js"></script>
    <!-- 3. date-fns ì–´ëŒ‘í„° -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2"></script>
    <script>
    // API í˜¸ì¶œ + ì—ëŸ¬ ë¡œê·¸
    fetch("{% url 'knowledge:session_counts_api' %}")
        .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
        })
        .then(data => {
        console.log('session_counts data:', data);
        const labels = data.map(d => d.day);
        const counts = data.map(d => d.count);

        const canvas = document.getElementById('session-count-chart');
        if (!canvas) return console.error('âš ï¸ canvas element ëª»ì°¾ìŒ');
        const ctx = canvas.getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
            labels,
            datasets: [{
                label: 'ì„¸ì…˜ ìˆ˜',
                data: counts,
                backgroundColor: 'rgba(59,130,246,0.5)',
                borderColor: 'rgba(59,130,246,1)',
                borderWidth: 1
            }]
            },
            options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                beginAtZero: true,
                ticks: { stepSize: 1 }
                }
            }
            }
        });
        })
        .catch(err => console.error('ğŸ”´ ì°¨íŠ¸ ë Œë”ë§ ì—ëŸ¬:', err));
    </script>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
        <section class="rounded-lg bg-white p-6 shadow-md border border-gray-200">
        <h3 class="text-xl font-semibold mb-4">ê°€ì…ì ìˆ˜ ì¶”ì´</h3>
        <div class="h-48 w-full">
            <canvas id="user-count-chart"></canvas>
        </div>
        </section>

        <script>
        document.addEventListener('DOMContentLoaded', () => {
        // ê°€ì…ì ìˆ˜ API í˜¸ì¶œ
        fetch("{% url 'knowledge:user_counts_api' %}")
            .then(res => {
            if (!res.ok) throw new Error('HTTP ' + res.status);
            return res.json();
            })
            .then(data => {
            const labels = data.map(d => d.day);
            const counts = data.map(d => d.count);

            const ctx = document
                .getElementById('user-count-chart')
                .getContext('2d');

            new Chart(ctx, {
                type: 'line',           // line ì°¨íŠ¸
                data: {
                labels,
                datasets: [{
                    label: 'ê°€ì…ì ìˆ˜',
                    data: counts,
                    fill: false,                 // ì„  ì•„ë˜ ì±„ìš°ê¸° ì—†ìŒ
                    borderColor: 'rgba(234, 88, 12, 1)', // Tailwind red-500
                    borderWidth: 2,
                    pointRadius: 3,
                    pointBackgroundColor: 'rgba(234, 88, 12, 1)'
                }]
                },
                options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                    }
                }
                }
            });
            })
            .catch(err => console.error('ê°€ì…ì ì°¨íŠ¸ ì—ëŸ¬:', err));
        });
        </script>

        <section class="rounded-lg bg-white p-6 shadow-md border border-gray-200">
            <h3 class="text-xl font-semibold mb-4">CPU/ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰</h3>
            <div class="h-48 w-full">
                <canvas id="ec2Chart" width="800" height="400"></canvas>                
            </div>
        </section>

        
    </div>

    </div>    
    </div>
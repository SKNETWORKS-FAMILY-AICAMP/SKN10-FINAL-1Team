<html><head>
  <meta charset="utf-8"/>
  <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
  <link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Inter%3Awght%40400%3B500%3B600%3B700%3B900&amp;family=Noto+Sans%3Awght%40400%3B500%3B600%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <title>Stitch Design</title>
  <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <style type="text/tailwindcss">
        :root {
          --primary-color: #dce8f3;
          --secondary-color: #f0f2f5;
          --text-primary: #111518;
          --text-secondary: #60768a;
          --border-color: #dbe1e6;
        }
        body {
          font-family: Inter, "Noto Sans", sans-serif;
        }
      </style>
  </head>
  <body class="bg-slate-50">
  <div class="relative flex size-full min-h-screen flex-col group/design-root overflow-x-hidden">
  <div id="header-placeholder"></div>
  <div class="layout-container flex h-full grow flex-col">
  <main class="flex-1 py-8 md:py-12 px-4 md:px-8">
  <div class="mx-auto max-w-2xl">
    {# Django Messages Block #}
    {% if messages %}
      <div class="mb-6 space-y-2">
        {% for message in messages %}
          <div class="p-4 rounded-md {% if message.tags == 'error' %}bg-red-100 border border-red-200 text-red-700{% elif message.tags == 'success' %}bg-green-100 border border-green-200 text-green-700{% elif message.tags == 'warning' %}bg-yellow-100 border border-yellow-200 text-yellow-700{% else %}bg-blue-100 border border-blue-200 text-blue-700{% endif %}" role="alert">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
    {# End Django Messages Block #}
  <div class="mb-8">
  <h1 class="text-slate-900 text-3xl md:text-4xl font-bold tracking-tight">Settings</h1>
  </div>
  <div class="space-y-10">
  <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
    <h2 class="text-slate-900 text-xl font-semibold mb-1">GitHub</h2>
    <p class="text-slate-600 text-sm mb-6">Connect your GitHub account to manage repositories.</p>

    {% if github_connected %}
        <div class="flex items-center gap-4 p-4 rounded-lg border border-green-200 bg-green-50">
            <div class="text-green-700 flex items-center justify-center rounded-lg bg-green-100 shrink-0 size-10">
                <svg fill="currentColor" height="24px" viewBox="0 0 256 256" width="24px" xmlns="http://www.w3.org/2000/svg"><path d="M208.31,75.68A59.78,59.78,0,0,0,202.93,28,8,8,0,0,0,196,24a59.75,59.75,0,0,0-48,24H124A59.75,59.75,0,0,0,76,24a8,8,0,0,0-6.93,4,59.78,59.78,0,0,0-5.38,47.68A58.14,58.14,0,0,0,56,104v8a56.06,56.06,0,0,0,48.44,55.47A39.8,39.8,0,0,0,96,192v8H72a24,24,0,0,1-24-24A40,40,0,0,0,8,136a8,8,0,0,0,0,16,24,24,0,0,1,24,24,40,40,0,0,0,40,40H96v16a8,8,0,0,0,16,0V192a24,24,0,0,1,48,0v40a8,8,0,0,0,16,0V192a39.8,39.8,0,0,0-8.44-24.53A56.06,56.06,0,0,0,216,112v-8A58.14,58.14,0,0,0,208.31,75.68ZM200,112a40,40,0,0,1-40,40H112a40,40,0,0,1-40-40v-8a41.74,41.74,0,0,1,6.9-22.48A8,8,0,0,0,80,73.83a43.81,43.81,0,0,1,.79-33.58,43.88,43.88,0,0,1,32.32,20.06A8,8,0,0,0,119.82,64h32.35a8,8,0,0,0,6.74-3.69,43.87,43.87,0,0,1,32.32-20.06A43.81,43.81,0,0,1,192,73.83a8.09,8.09,0,0,0,1,7.65A41.72,41.72,0,0,1,200,104Z"></path></svg>
            </div>
            <div class="flex-grow">
                <p class="text-slate-800 text-base font-medium leading-normal">Connected to GitHub</p>
                {% if github_username %}
                <p class="text-slate-500 text-sm font-normal leading-normal">Connected as: {{ github_username }}</p>
                {% endif %}
            </div>
            <div class="flex items-center ml-auto gap-3">
                <form method="post" action="{% url 'accounts:github_disconnect' %}" class="m-0">
                    {% csrf_token %}
                    <button type="submit" class="flex min-w-[110px] items-center justify-center rounded-md h-9 px-4 bg-red-600 hover:bg-red-500 text-white text-sm font-medium shadow-sm transition-colors focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-500">
                        <span class="truncate">Disconnect</span>
                    </button>
                </form>
                <button type="button" id="scanRepositoriesBtn" class="flex min-w-[170px] items-center justify-center rounded-md h-9 px-4 bg-slate-800 hover:bg-slate-700 text-white text-sm font-medium shadow-sm transition-colors focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-500">
                    <span class="material-symbols-outlined mr-1.5 text-base">sync</span>
                    <span class="truncate">Scan Repositories</span>
                </button>
            </div>
        </div>

        <!-- Add Repository by URL Section -->
        <div class="mt-6 pt-6 border-t border-slate-200">
            <h3 class="text-lg font-medium leading-6 text-slate-900">Repositories</h3>
            <p class="mt-1 text-sm text-slate-600">Manually add repositories by providing their URL.</p>
            <div class="mt-4 flex gap-3 items-start">
                <div class="flex-grow">
                    <label for="repository_url" class="block text-sm font-medium text-slate-700 sr-only">Repository URL</label>
                    <input type="text" name="repository_url" id="repository_url" class="form-input block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-9 px-3 py-2 placeholder:text-slate-400" placeholder="https://github.com/owner/repository">
                    <p id="publicRepoUrlError" class="mt-1 text-xs text-red-600" style="display: none;"></p>
                </div>
                <button type="button" id="addPublicRepositoryBtn" class="flex min-w-[150px] items-center justify-center rounded-md h-9 px-4 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium shadow-sm transition-colors focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500">
                    Add Repository
                </button>
            </div>
        </div>
    {% else %}
        <div class="flex items-center gap-4 p-4 rounded-lg border border-slate-200 hover:bg-slate-50 transition-colors">
            <div class="text-slate-700 flex items-center justify-center rounded-lg bg-slate-100 shrink-0 size-10">
                <svg fill="currentColor" height="24px" viewBox="0 0 256 256" width="24px" xmlns="http://www.w3.org/2000/svg"><path d="M208.31,75.68A59.78,59.78,0,0,0,202.93,28,8,8,0,0,0,196,24a59.75,59.75,0,0,0-48,24H124A59.75,59.75,0,0,0,76,24a8,8,0,0,0-6.93,4,59.78,59.78,0,0,0-5.38,47.68A58.14,58.14,0,0,0,56,104v8a56.06,56.06,0,0,0,48.44,55.47A39.8,39.8,0,0,0,96,192v8H72a24,24,0,0,1-24-24A40,40,0,0,0,8,136a8,8,0,0,0,0,16,24,24,0,0,1,24,24,40,40,0,0,0,40,40H96v16a8,8,0,0,0,16,0V192a24,24,0,0,1,48,0v40a8,8,0,0,0,16,0V192a39.8,39.8,0,0,0-8.44-24.53A56.06,56.06,0,0,0,216,112v-8A58.14,58.14,0,0,0,208.31,75.68ZM200,112a40,40,0,0,1-40,40H112a40,40,0,0,1-40-40v-8a41.74,41.74,0,0,1,6.9-22.48A8,8,0,0,0,80,73.83a43.81,43.81,0,0,1,.79-33.58,43.88,43.88,0,0,1,32.32,20.06A8,8,0,0,0,119.82,64h32.35a8,8,0,0,0,6.74-3.69,43.87,43.87,0,0,1,32.32-20.06A43.81,43.81,0,0,1,192,73.83a8.09,8.09,0,0,0,1,7.65A41.72,41.72,0,0,1,200,104Z"></path></svg>
            </div>
            <div class="flex-grow">
                <p class="text-slate-800 text-base font-medium leading-normal">Connect to GitHub</p>
                <p class="text-slate-500 text-sm font-normal leading-normal">Sync your repositories by connecting your GitHub account.</p>
            </div>
            <button id="connectGitHubBtn" class="flex min-w-[90px] items-center justify-center rounded-md h-9 px-4 bg-slate-800 hover:bg-slate-700 text-white text-sm font-medium shadow-sm transition-colors focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-500">
                <span class="truncate">Connect</span>
            </button>
        </div>
    {% endif %}
  </section>

<!-- GitHub PAT Modal -->
<div id="githubPatModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 50;">
    <div class="relative p-8 bg-white w-full max-w-md m-auto flex-col flex rounded-lg shadow-lg">
        <button id="closeModalBtn" class="absolute top-0 right-0 mt-4 mr-4 text-gray-400 hover:text-gray-600">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
        <h3 class="text-xl font-semibold text-slate-900 mb-6">Connect to GitHub with PAT</h3>
        <form id="githubPatForm" method="post" action="{% url 'accounts:github_connect' %}">
            {% csrf_token %}
            <div class="mb-4">
                <label for="github_pat" class="block text-sm font-medium text-slate-700 mb-1">GitHub Personal Access Token</label>
                <input type="password" name="github_pat" id="github_pat" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Enter your PAT" required>
                <p class="mt-2 text-xs text-slate-500">
                    Ensure your PAT has the necessary scopes (e.g., 'repo'). 
                    <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens" target="_blank" class="text-indigo-600 hover:text-indigo-800">Learn more about PATs</a>.
                </p>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancelModalBtn" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md shadow-sm transition-colors">Cancel</button>
                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-slate-800 hover:bg-slate-700 rounded-md shadow-sm transition-colors">Connect with Token</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const connectGitHubBtn = document.getElementById('connectGitHubBtn');
    const githubPatModal = document.getElementById('githubPatModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const cancelModalBtn = document.getElementById('cancelModalBtn');
    const githubPatInput = document.getElementById('github_pat');

    if (connectGitHubBtn) {
        connectGitHubBtn.addEventListener('click', function () {
            if (githubPatModal) githubPatModal.style.display = 'flex';
        });
    }

    function closeModal() {
        if (githubPatModal) githubPatModal.style.display = 'none';
        if (githubPatInput) {
            githubPatInput.value = ''; // Clear the input field
        }
    }

    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeModal);
    }
    if (cancelModalBtn) {
        cancelModalBtn.addEventListener('click', closeModal);
    }

    // Optional: Close modal if clicked outside of it
    window.addEventListener('click', function (event) {
        if (event.target === githubPatModal) {
            closeModal();
        }
    });
});

  </script>

<!-- GitHub Token Modal -->
<div id="github-token-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
    <div class="relative p-8 bg-white w-full max-w-md m-auto flex-col flex rounded-lg shadow-lg">
      <button id="close-modal-btn" class="absolute top-0 right-0 mt-4 mr-4 text-gray-400 hover:text-gray-600">
        <span class="material-symbols-outlined">close</span>
      </button>
      <h2 class="text-xl font-semibold mb-4">Connect to GitHub with Token</h2>
      <form id="github-token-form" method="post" action="{% url 'accounts:github_connect' %}">
        {% csrf_token %}
        <div class="mb-4">
          <label for="github_token" class="block text-sm font-medium text-slate-700 mb-1.5">GitHub Personal Access Token</label>
          <input type="password" name="github_token" id="github_token" required
                 class="form-input block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm h-11 px-3 py-2 placeholder:text-slate-400"
                 placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
          <p class="text-xs text-slate-500 mt-1">
            Create a token with <code class="bg-slate-100 px-1 rounded">repo</code> scope from 
            <a href="https://github.com/settings/tokens" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">GitHub settings</a>.
          </p>
        </div>
        <div class="flex justify-end space-x-2">
          <button type="button" id="cancel-modal-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">Cancel</button>
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-slate-800 hover:bg-slate-700 rounded-md">Connect with Token</button>
        </div>
      </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Header Loading ---
    function loadHeader() {
        fetch('/_header.html') // Path to the shared header
            .then(response => response.text())
            .then(data => {
                const headerPlaceholder = document.getElementById('header-placeholder');
                if (headerPlaceholder) {
                    headerPlaceholder.innerHTML = data;
                }
                
                const mobileSidebarToggle = document.getElementById('open-sidebar-mobile');
                if (mobileSidebarToggle) {
                  mobileSidebarToggle.style.display = 'none';
                }

                const navLink = document.querySelector(`nav a[data-navlink='settings']`); 
                if (navLink) {
                    navLink.classList.add('text-[var(--text-primary)]', 'bg-[var(--secondary-color)]');
                    navLink.classList.remove('text-[var(--text-secondary)]');
                }
            })
            .catch(error => console.error('Error loading header:', error));
    }
    loadHeader();

    // --- CSRF Token ---
    const csrfTokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    const csrfToken = csrfTokenInput ? csrfTokenInput.value : null;
    if (!csrfToken) {
        console.warn('CSRF token not found. Some operations may not work.');
    }

    // --- GitHub PAT Modal Elements & Logic ---
    const connectButton = document.getElementById('connect-github-btn'); 
    const githubTokenModal = document.getElementById('github-token-modal'); 
    const closeModalButton = document.getElementById('close-modal-btn'); 
    const cancelModalButton = document.getElementById('cancel-modal-btn'); 

    if (connectButton && githubTokenModal) {
      connectButton.addEventListener('click', () => {
        githubTokenModal.style.display = 'flex';
      });
    }

    function closePatModal() {
        if (githubTokenModal) githubTokenModal.style.display = 'none';
        // Optionally clear token input if one exists and is part of this modal
    }

    if (closeModalButton && githubTokenModal) {
      closeModalButton.addEventListener('click', closePatModal);
    }

    if (cancelModalButton && githubTokenModal) {
      cancelModalButton.addEventListener('click', closePatModal);
    }
    
    if (githubTokenModal) { // Click outside for PAT modal
        githubTokenModal.addEventListener('click', (event) => {
            if (event.target === githubTokenModal) {
                closePatModal();
            }
        });
    }

    // --- Scan Repositories Modal Elements & Logic ---
    const scanRepositoriesBtn = document.getElementById('scanRepositoriesBtn');
    const scanRepositoriesModal = document.getElementById('scanRepositoriesModal');
    const closeScanModalBtn = document.getElementById('closeScanModalBtn');
    const cancelScanSelectedBtn = document.getElementById('cancelScanSelectedBtn');
    const startScanSelectedBtn = document.getElementById('startScanSelectedBtn');
    const repositoryListContainer = document.getElementById('repositoryListContainer');
    const selectAllReposCheckbox = document.getElementById('selectAllReposCheckbox');
    const scanFeedback = document.getElementById('scanFeedback');

    if (scanRepositoriesBtn) {
        scanRepositoriesBtn.addEventListener('click', () => {
            if (scanRepositoriesModal) {
                scanRepositoriesModal.style.display = 'flex';
                fetchUserRepositories();
            }
        });
    }

    function closeTheScanModal() {
        if (scanRepositoriesModal) scanRepositoriesModal.style.display = 'none';
        if (repositoryListContainer) repositoryListContainer.innerHTML = '<p class="text-slate-500">Loading repositories...</p>';
        if (selectAllReposCheckbox) selectAllReposCheckbox.checked = false;
        if (scanFeedback) scanFeedback.innerHTML = '';
    }

    if (closeScanModalBtn) {
        closeScanModalBtn.addEventListener('click', closeTheScanModal);
    }
    if (cancelScanSelectedBtn) {
        cancelScanSelectedBtn.addEventListener('click', closeTheScanModal);
    }
    if (scanRepositoriesModal) { // Click outside for Scan modal
        scanRepositoriesModal.addEventListener('click', (event) => {
            if (event.target === scanRepositoriesModal) {
                closeTheScanModal();
            }
        });
    }

    async function fetchUserRepositories() {
        if (!repositoryListContainer) return;
        repositoryListContainer.innerHTML = '<p class="text-slate-500 animate-pulse">Loading repositories...</p>';
        try {
            const response = await fetch("{% url 'accounts:list_github_repositories' %}");
            if (!response.ok) {
                const errData = await response.json().catch(() => ({}));
                throw new Error(errData.error || `HTTP error! status: ${response.status}`);
            }
            const data = await response.json(); // Get the whole object
            
            if (!data || !Array.isArray(data.repositories)) { // Check if data.repositories is an array
                 repositoryListContainer.innerHTML = `<p class="text-red-500">Error: Unexpected response format from server or no repositories array.</p>`;
                 console.error('Expected an object with a repositories array, got:', data);
                 return;
            }

            const repos = data.repositories; // Access the array

            if (repos.length === 0) {
                repositoryListContainer.innerHTML = '<p class="text-slate-500">No repositories found. Your token might not have access to any repositories, or you may not have any repositories on GitHub.</p>';
                return;
            }

            async function loadBranchesForRepo(selectElement, owner, repoName, defaultBranch) {
                selectElement.disabled = true;
                selectElement.innerHTML = `<option value="">Loading...</option>`;
                try {
                    const response = await fetch(`/accounts/github/list_branches/?owner=${encodeURIComponent(owner)}&repo_name=${encodeURIComponent(repoName)}`);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    selectElement.innerHTML = ''; // Clear loading/previous options
                    if (data.branches && data.branches.length > 0) {
                        data.branches.forEach(branchName => {
                            const option = document.createElement('option');
                            option.value = branchName;
                            option.textContent = branchName;
                            if (branchName === defaultBranch) {
                                option.selected = true;
                            }
                            selectElement.appendChild(option);
                        });
                    } else {
                        selectElement.innerHTML = `<option value="${defaultBranch}">${defaultBranch} (No other branches found)</option>`;
                    }
                } catch (error) {
                    console.error(`Error loading branches for ${owner}/${repoName}:`, error);
                    selectElement.innerHTML = `<option value="${defaultBranch}">${defaultBranch} (Error loading)</option>`;
                } finally {
                    selectElement.disabled = false;
                }
            }

            function displayRepositories(repositories) {
                const container = document.getElementById('repositoryListContainer');
                if (!repositories || repositories.length === 0) {
                    container.innerHTML = '<p class="text-slate-500">No repositories found or an error occurred.</p>';
                    return;
                }

                let repoHtml = '<ul class="space-y-3">';
                repositories.forEach(repo => {
                    const isPrivate = repo.private ? '<span class="ml-2 px-2 py-0.5 text-xs font-medium text-purple-700 bg-purple-100 rounded-full">Private</span>' : '';
                    const defaultBranch = repo.default_branch || 'main';
                    // Extract owner and repo_name from full_name for the API call
                    // Assumes full_name is in 'owner/repo_name' format
                    const [owner, repoName] = repo.full_name.split('/');

                    repoHtml += `
                        <li class="p-3 bg-slate-50 hover:bg-slate-100 rounded-md border border-slate-200 transition-colors">
                            <div class="flex items-center justify-between">
                                <label for="repo-${repo.id}" class="flex items-center text-sm text-slate-800 font-medium cursor-pointer flex-grow">
                                    <input type="checkbox" id="repo-${repo.id}" name="selected_repos" value="${repo.html_url}" data-repo-id="${repo.id}" class="form-checkbox h-4 w-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500 mr-3 repo-checkbox">
                                    <span class="truncate" title="${repo.full_name}">${repo.full_name}</span>
                                    ${isPrivate}
                                </label>
                                <div class="ml-2 flex items-center" style="min-width: 180px;">
                                    <span class="text-xs text-slate-500 mr-1">Branch:</span>
                                    <select id="branch-select-${repo.id}" data-repo-url="${repo.html_url}" data-repo-owner="${owner}" data-repo-name="${repoName}" data-default-branch="${defaultBranch}" class="repo-branch-select form-select h-7 text-xs p-1 border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 w-full">
                                        <option value="${defaultBranch}">${defaultBranch} (Loading...)</option>
                                    </select>
                                </div>
                            </div>
                        </li>`;
                });
                repoHtml += '</ul>';
                container.innerHTML = repoHtml;

                // After rendering, load branches for each select dropdown
                repositories.forEach(repo => {
                    const selectElement = document.getElementById(`branch-select-${repo.id}`);
                    if (selectElement) {
                        const owner = selectElement.dataset.repoOwner;
                        const repoName = selectElement.dataset.repoName;
                        const defaultBranch = selectElement.dataset.defaultBranch;
                        loadBranchesForRepo(selectElement, owner, repoName, defaultBranch);
                    }
                });
            }

            displayRepositories(repos);
        } catch (error) {
            console.error('Error fetching repositories:', error);
            repositoryListContainer.innerHTML = `<p class="text-red-500">Failed to load repositories. ${error.message}</p>`;
        }
    }

    if (selectAllReposCheckbox && repositoryListContainer) {
        selectAllReposCheckbox.addEventListener('change', (event) => {
            const checkboxes = repositoryListContainer.querySelectorAll('input[name="selected_repos"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = event.target.checked;
            });
        });
    }
    
    if (repositoryListContainer && selectAllReposCheckbox) {
        repositoryListContainer.addEventListener('change', function(event) {
            if (event.target.matches('input[name="selected_repos"].repo-checkbox')) {
                if (!event.target.checked) {
                    selectAllReposCheckbox.checked = false;
                } else {
                    const allCheckboxes = repositoryListContainer.querySelectorAll('input[name="selected_repos"]');
                    const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                    if (allChecked) {
                        selectAllReposCheckbox.checked = true;
                    }
                }
            }
        });
    }

    if (startScanSelectedBtn && repositoryListContainer && scanFeedback) {
        startScanSelectedBtn.addEventListener('click', async () => {
            if (!csrfToken) {
                scanFeedback.innerHTML = '<p class="text-red-500 text-sm">Critical error: CSRF token not available. Cannot proceed.</p>';
                return;
            }
            const selectedRepoCheckboxes = document.querySelectorAll('.repo-checkbox:checked');
            const repoUrlsToScan = [];

            selectedRepoCheckboxes.forEach(checkbox => {
                const repoBaseUrl = checkbox.value; // This is repo.html_url
                const repoId = checkbox.dataset.repoId;
                const branchSelect = document.getElementById(`branch-select-${repoId}`);
                let branchName = 'main'; // Default branch if select not found or no value
                if (branchSelect && branchSelect.value) {
                    branchName = branchSelect.value;
                }
                
                // Construct the URL for scanning: https://github.com/owner/repo/tree/branch_name
                const fullUrlToScan = `${repoBaseUrl}/tree/${branchName}`;
                repoUrlsToScan.push(fullUrlToScan);
            });

            if (repoUrlsToScan.length === 0) {
                scanFeedback.innerHTML = '<p class="text-orange-500 text-sm">Please select at least one repository to scan.</p>';
                startScanSelectedBtn.disabled = false;
                startScanSelectedBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                return;
            }

            scanFeedback.innerHTML = '<p class="text-blue-600 text-sm">Initiating scan for selected repositories...</p>';

            try {
                const response = await fetch("{% url 'accounts:scan_selected_repositories' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ repo_urls: repoUrlsToScan })
                });

                const result = await response.json();

                if (response.ok && result.status === 'completed') {
                    let resultHtml = '<p class="text-green-600 text-sm mb-2">Scan process results:</p><ul class="list-disc list-inside text-sm space-y-1">';
                    if (result.results && Array.isArray(result.results)){
                        result.results.forEach(res => {
                            resultHtml += `<li class="${res.status === 'success' ? 'text-green-700' : 'text-red-700'} break-all"><strong>${res.repo_url}</strong>: ${res.message}</li>`;
                        });
                    } else {
                        resultHtml += '<li class="text-orange-500">No detailed results returned.</li>';
                    }
                    resultHtml += '</ul>';
                    scanFeedback.innerHTML = resultHtml;
                } else {
                    scanFeedback.innerHTML = `<p class="text-red-500 text-sm">Error: ${result.message || result.error || 'Scan failed or did not complete as expected.'}</p>`;
                }
            } catch (error) {
                console.error('Error starting scan:', error);
                scanFeedback.innerHTML = `<p class="text-red-500 text-sm">An error occurred: ${error.message}</p>`;
            } finally {
                startScanSelectedBtn.disabled = false;
                startScanSelectedBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });
    }

    // --- Public Repository Scan Logic ---
    const addPublicRepositoryBtn = document.getElementById('addPublicRepositoryBtn');
    addPublicRepositoryBtn.textContent = 'Add Repository';
    const publicRepoUrlInput = document.getElementById('repository_url');
    const publicRepoUrlError = document.getElementById('publicRepoUrlError'); 

    const scanPublicRepoModal = document.getElementById('scanPublicRepoModal');
    const closePublicScanModalBtn = document.getElementById('closePublicScanModalBtn');
    const publicRepoUrlDisplay = document.getElementById('publicRepoUrlDisplay');
    const publicRepoBranchListContainer = document.getElementById('publicRepoBranchListContainer');
    const selectAllPublicRepoBranchesCheckbox = document.getElementById('selectAllPublicRepoBranchesCheckbox');
    const scanPublicRepoFeedback = document.getElementById('scanPublicRepoFeedback');
    const cancelPublicScanBtn = document.getElementById('cancelPublicScanBtn');
    const startScanPublicRepoBranchesBtn = document.getElementById('startScanPublicRepoBranchesBtn');
    
    let currentPublicRepoUrl = ''; // To store the URL for scanning

    // TODO: Replace with Django URL template tag once defined: {% url 'accounts:list_public_repository_branches' %}
    const listPublicRepoBranchesUrl = '/accounts/list-public-repository-branches/'; 

    if (addPublicRepositoryBtn) {
        addPublicRepositoryBtn.addEventListener('click', async function() {
            const repoUrl = publicRepoUrlInput.value.trim();
            publicRepoUrlError.style.display = 'none';
            publicRepoUrlError.textContent = '';

            if (!repoUrl) {
                publicRepoUrlError.textContent = 'Please enter a repository URL.';
                publicRepoUrlError.style.display = 'block';
                return;
            }
            if (!repoUrl.startsWith('https://github.com/')) {
                publicRepoUrlError.textContent = 'Please enter a valid GitHub repository URL (e.g., https://github.com/user/repo).';
                publicRepoUrlError.style.display = 'block';
                return;
            }

            currentPublicRepoUrl = repoUrl; 
            publicRepoUrlDisplay.textContent = `Repository: ${repoUrl}`;
            scanPublicRepoModal.style.display = 'flex';
            publicRepoBranchListContainer.innerHTML = '<p class="text-slate-500">Loading branches...</p>';
            scanPublicRepoFeedback.innerHTML = '';
            selectAllPublicRepoBranchesCheckbox.checked = false;
            startScanPublicRepoBranchesBtn.disabled = true; // Disable scan button until branches are loaded

            try {
                const response = await fetch(`${listPublicRepoBranchesUrl}?repo_url=${encodeURIComponent(repoUrl)}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Failed to fetch branches. Ensure the URL is correct, the repository is public, and the server endpoint is available.' }));
                    throw new Error(errorData.message || `HTTP error ${response.status}`);
                }
                const branches = await response.json();

                if (branches && branches.length > 0) {
                    let branchListHtml = '<ul class="space-y-2">';
                    branches.forEach(branch => {
                        branchListHtml += `
                            <li>
                                <label class="flex items-center text-sm text-slate-700">
                                    <input type="checkbox" name="publicRepoBranch" value="${branch.name}" class="form-checkbox h-4 w-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500 mr-2 public-repo-branch-checkbox">
                                    ${branch.name}
                                </label>
                            </li>`;
                    });
                    branchListHtml += '</ul>';
                    publicRepoBranchListContainer.innerHTML = branchListHtml;
                    startScanPublicRepoBranchesBtn.disabled = false; // Enable scan button
                } else {
                    publicRepoBranchListContainer.innerHTML = '<p class="text-slate-500">No branches found or repository is not accessible. Ensure it is a public repository.</p>';
                }
            } catch (error) {
                console.error('Error fetching public repo branches:', error);
                publicRepoBranchListContainer.innerHTML = `<p class="text-red-500 text-sm">Error: ${error.message}</p>`;
            }
        });
    }

    if (closePublicScanModalBtn) {
        closePublicScanModalBtn.addEventListener('click', () => {
            scanPublicRepoModal.style.display = 'none';
        });
    }
    if (cancelPublicScanBtn) {
        cancelPublicScanBtn.addEventListener('click', () => {
            scanPublicRepoModal.style.display = 'none';
        });
    }

    if (selectAllPublicRepoBranchesCheckbox) {
        selectAllPublicRepoBranchesCheckbox.addEventListener('change', function() {
            const checkboxes = publicRepoBranchListContainer.querySelectorAll('input[name="publicRepoBranch"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }

    if (publicRepoBranchListContainer) { 
        publicRepoBranchListContainer.addEventListener('change', function(event) {
            if (event.target.name === 'publicRepoBranch') {
                const allCheckboxes = publicRepoBranchListContainer.querySelectorAll('input[name="publicRepoBranch"]');
                const checkedCheckboxes = publicRepoBranchListContainer.querySelectorAll('input[name="publicRepoBranch"]:checked');
                selectAllPublicRepoBranchesCheckbox.checked = allCheckboxes.length === checkedCheckboxes.length && allCheckboxes.length > 0;
            }
        });
    }
    
    if (startScanPublicRepoBranchesBtn) {
        startScanPublicRepoBranchesBtn.addEventListener('click', async function() {
            const selectedBranchCheckboxes = publicRepoBranchListContainer.querySelectorAll('input[name="publicRepoBranch"]:checked');
            const branchesToScan = Array.from(selectedBranchCheckboxes).map(cb => cb.value);

            if (branchesToScan.length === 0) {
                scanPublicRepoFeedback.innerHTML = '<p class="text-red-500 text-sm">Please select at least one branch to scan.</p>';
                return;
            }

            scanPublicRepoFeedback.innerHTML = '<p class="text-slate-600 text-sm">Initiating scan for selected branches...</p>';
            startScanPublicRepoBranchesBtn.disabled = true;
            startScanPublicRepoBranchesBtn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                const response = await fetch(scanSelectedRepositoriesUrl, { // scanSelectedRepositoriesUrl is defined earlier
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken // csrfToken is defined earlier
                    },
                    body: JSON.stringify({ 
                        public_repo_url: currentPublicRepoUrl, 
                        branches: branchesToScan,
                        scan_type: 'public_branches' 
                    })
                });

                const result = await response.json();
                scanPublicRepoFeedback.innerHTML = ''; 

                if (response.ok && result.status === 'completed') {
                    let resultHtml = `<p class="text-green-600 text-sm mb-2">Scan process results for ${currentPublicRepoUrl}:</p><ul class="list-disc list-inside text-sm space-y-1">`;
                    if (result.results && Array.isArray(result.results)){
                        result.results.forEach(res => {
                            resultHtml += `<li class="${res.status === 'success' ? 'text-green-700' : 'text-red-700'} break-all"><strong>Branch ${res.branch_name || 'Unknown'}</strong>: ${res.message}</li>`;
                        });
                    } else {
                         resultHtml += '<li class="text-orange-500">No detailed results returned or format is unexpected.</li>';
                    }
                    resultHtml += '</ul>';
                    scanPublicRepoFeedback.innerHTML = resultHtml;
                } else {
                    scanPublicRepoFeedback.innerHTML = `<p class="text-red-500 text-sm">Error: ${result.message || result.error || 'Scan failed or did not complete as expected.'}</p>`;
                }
            } catch (error) {
                console.error('Error starting public repo scan:', error);
                scanPublicRepoFeedback.innerHTML = `<p class="text-red-500 text-sm">An error occurred: ${error.message}</p>`;
            } finally {
                startScanPublicRepoBranchesBtn.disabled = false;
                startScanPublicRepoBranchesBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });
    }
    // --- End Public Repository Scan Logic ---
});

  </script>

<!-- Scan Repositories Modal -->
<div id="scanRepositoriesModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 60;">
    <div class="relative p-8 bg-white w-full max-w-2xl m-auto flex-col flex rounded-lg shadow-lg">
        <button id="closeScanModalBtn" class="absolute top-0 right-0 mt-4 mr-4 text-gray-400 hover:text-gray-600">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
        <h3 class="text-xl font-semibold text-slate-900 mb-6">Scan Your GitHub Repositories</h3>
        
        <div id="repositoryListContainer" class="mb-6 h-64 overflow-y-auto border border-slate-300 rounded-md p-4">
            <!-- Repository list will be loaded here by JavaScript -->
            <p class="text-slate-500">Loading repositories...</p> 
        </div>

        <div class="flex justify-between items-center mb-4">
            <div>
                <label for="selectAllReposCheckbox" class="flex items-center text-sm text-slate-700">
                    <input type="checkbox" id="selectAllReposCheckbox" class="form-checkbox h-4 w-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500 mr-2">
                    Select All Repositories
                </label>
            </div>
        </div>

        <div id="scanFeedback" class="my-3"></div> <!-- Feedback area -->

        <div class="flex justify-end gap-3">
            <button type="button" id="cancelScanSelectedBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md shadow-sm transition-colors">Cancel</button>
            <button type="button" id="startScanSelectedBtn" class="px-4 py-2 text-sm font-medium text-white bg-slate-800 hover:bg-slate-700 rounded-md flex items-center justify-center">
                <span class="material-symbols-outlined mr-1.5 text-base" style="font-size: 1.125rem; vertical-align: text-bottom;">search_check</span>
                Scan Selected
            </button>
        </div>
    </div>
</div>

<!-- Scan Public Repository Modal -->
<div id="scanPublicRepoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 70;">
    <div class="relative p-8 bg-white w-full max-w-2xl m-auto flex-col flex rounded-lg shadow-lg">
        <button id="closePublicScanModalBtn" class="absolute top-0 right-0 mt-4 mr-4 text-gray-400 hover:text-gray-600">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
        <h3 class="text-xl font-semibold text-slate-900 mb-1">Scan Url Github Repository</h3>
        <p id="publicRepoUrlDisplay" class="text-sm text-slate-600 mb-6 break-all"></p>
        
        <div id="publicRepoBranchListContainer" class="mb-6 h-64 overflow-y-auto border border-slate-300 rounded-md p-4">
            <!-- Branch list will be loaded here by JavaScript -->
            <p class="text-slate-500">Loading branches...</p> 
        </div>

        <div class="flex justify-between items-center mb-4">
            <div>
                <label for="selectAllPublicRepoBranchesCheckbox" class="flex items-center text-sm text-slate-700">
                    <input type="checkbox" id="selectAllPublicRepoBranchesCheckbox" class="form-checkbox h-4 w-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500 mr-2">
                    Select All Branches
                </label>
            </div>
        </div>

        <div id="scanPublicRepoFeedback" class="my-3"></div> <!-- Feedback area -->

        <div class="flex justify-end gap-3">
            <button type="button" id="cancelPublicScanBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md shadow-sm transition-colors">Cancel</button>
            <button type="button" id="startScanPublicRepoBranchesBtn" class="px-4 py-2 text-sm font-medium text-white bg-slate-800 hover:bg-slate-700 rounded-md flex items-center justify-center" disabled>
                <span class="material-symbols-outlined mr-1.5 text-base" style="font-size: 1.125rem; vertical-align: text-bottom;">search_check</span>
                Scan Selected Branches
            </button>
        </div>
    </div>
</div>

  {% if github_connected %}
  <section id="addRepositorySection" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
    <h2 class="text-slate-900 text-xl font-semibold mb-1">Repositories</h2>
    <p class="text-slate-600 text-sm mb-6">Manually add repositories by providing their URL.</p>
    <div class="space-y-4">
        <div>
            <label class="block text-sm font-medium text-slate-700 mb-1.5" for="repository_url_input">Repository URL</label>
            <input name="repository_url" id="repository_url_input" class="form-input block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm h-11 px-3 py-2 placeholder:text-slate-400" placeholder="https://github.com/username/repository-name" type="url" value=""/>
            <p id="addRepoError" class="text-red-500 text-sm mt-1" style="display: none;"></p>
        </div>
        <div class="flex justify-end">
            <button type="button" id="addRepositoryBtn" class="flex min-w-[150px] items-center justify-center rounded-md h-10 px-4 bg-slate-800 hover:bg-slate-700 text-white text-sm font-semibold shadow-sm transition-colors focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-500">
                <span class="material-symbols-outlined mr-1.5 text-base">add</span>
                <span class="truncate">Add Repository</span>
            </button>
        </div>
    </div>
  </section>
  {% else %}
  <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 opacity-50 pointer-events-none">
    <h2 class="text-slate-900 text-xl font-semibold mb-1">Repositories</h2>
    <p class="text-slate-600 text-sm mb-4">Manually add repositories by providing their URL.</p>
    <p class="text-sm text-orange-600 mb-6 font-medium"><span class="material-symbols-outlined align-middle text-base mr-1">warning</span>Please connect to GitHub first to add repositories.</p>
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1.5" for="repo-url-disabled">Repository URL</label>
        <input class="form-input block w-full rounded-md border-slate-300 shadow-sm bg-slate-100 text-slate-500 sm:text-sm h-11 px-3 py-2 placeholder:text-slate-400 cursor-not-allowed" id="repo-url-disabled" placeholder="https://github.com/username/repository-name" type="url" value="" disabled/>
      </div>
      <div class="flex justify-end">
        <button class="flex min-w-[120px] items-center justify-center rounded-md h-10 px-4 bg-slate-300 text-slate-500 text-sm font-semibold shadow-sm cursor-not-allowed" disabled>
          <span class="material-symbols-outlined mr-1.5 text-base"> add </span>
          <span class="truncate">Add Repository</span>
        </button>
      </div>
    </div>
  </section>
  {% endif %}
  </div>
  </div>
  </main>
  </div>
  </div>
  
  </body></html>